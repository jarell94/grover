{"dependencies":[{"name":"./syncpromise.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":89,"index":89}}],"key":"r9D+KVM39qpXh7dXewX99qgTA/A=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"SENTRY_BUFFER_FULL_ERROR\", {\n    enumerable: true,\n    get: function () {\n      return SENTRY_BUFFER_FULL_ERROR;\n    }\n  });\n  Object.defineProperty(exports, \"makePromiseBuffer\", {\n    enumerable: true,\n    get: function () {\n      return makePromiseBuffer;\n    }\n  });\n  var _syncpromiseJs = require(_dependencyMap[0], \"./syncpromise.js\");\n  const SENTRY_BUFFER_FULL_ERROR = Symbol.for('SentryBufferFullError');\n\n  /**\n   * Creates an new PromiseBuffer object with the specified limit\n   * @param limit max number of promises that can be stored in the buffer\n   */\n  function makePromiseBuffer(limit) {\n    const buffer = [];\n    function isReady() {\n      return limit === undefined || buffer.length < limit;\n    }\n\n    /**\n     * Remove a promise from the queue.\n     *\n     * @param task Can be any PromiseLike<T>\n     * @returns Removed promise.\n     */\n    function remove(task) {\n      return buffer.splice(buffer.indexOf(task), 1)[0] || Promise.resolve(undefined);\n    }\n\n    /**\n     * Add a promise (representing an in-flight action) to the queue, and set it to remove itself on fulfillment.\n     *\n     * @param taskProducer A function producing any PromiseLike<T>; In previous versions this used to be `task:\n     *        PromiseLike<T>`, but under that model, Promises were instantly created on the call-site and their executor\n     *        functions therefore ran immediately. Thus, even if the buffer was full, the action still happened. By\n     *        requiring the promise to be wrapped in a function, we can defer promise creation until after the buffer\n     *        limit check.\n     * @returns The original promise.\n     */\n    function add(taskProducer) {\n      if (!isReady()) {\n        return (0, _syncpromiseJs.rejectedSyncPromise)(SENTRY_BUFFER_FULL_ERROR);\n      }\n\n      // start the task and add its promise to the queue\n      const task = taskProducer();\n      if (buffer.indexOf(task) === -1) {\n        buffer.push(task);\n      }\n      void task.then(() => remove(task))\n      // Use `then(null, rejectionHandler)` rather than `catch(rejectionHandler)` so that we can use `PromiseLike`\n      // rather than `Promise`. `PromiseLike` doesn't have a `.catch` method, making its polyfill smaller. (ES5 didn't\n      // have promises, so TS has to polyfill when down-compiling.)\n      .then(null, () => remove(task).then(null, () => {\n        // We have to add another catch here because `remove()` starts a new promise chain.\n      }));\n      return task;\n    }\n\n    /**\n     * Wait for all promises in the queue to resolve or for timeout to expire, whichever comes first.\n     *\n     * @param timeout The time, in ms, after which to resolve to `false` if the queue is still non-empty. Passing `0` (or\n     * not passing anything) will make the promise wait as long as it takes for the queue to drain before resolving to\n     * `true`.\n     * @returns A promise which will resolve to `true` if the queue is already empty or drains before the timeout, and\n     * `false` otherwise\n     */\n    function drain(timeout) {\n      return new _syncpromiseJs.SyncPromise((resolve, reject) => {\n        let counter = buffer.length;\n        if (!counter) {\n          return resolve(true);\n        }\n\n        // wait for `timeout` ms and then resolve to `false` (if not cancelled first)\n        const capturedSetTimeout = setTimeout(() => {\n          if (timeout && timeout > 0) {\n            resolve(false);\n          }\n        }, timeout);\n\n        // if all promises resolve in time, cancel the timer and resolve to `true`\n        buffer.forEach(item => {\n          void (0, _syncpromiseJs.resolvedSyncPromise)(item).then(() => {\n            if (! --counter) {\n              clearTimeout(capturedSetTimeout);\n              resolve(true);\n            }\n          }, reject);\n        });\n      });\n    }\n    return {\n      $: buffer,\n      add,\n      drain\n    };\n  }\n});","lineCount":112,"map":[[7,2,102,0,"Object"],[7,8,102,0],[7,9,102,0,"defineProperty"],[7,23,102,0],[7,24,102,0,"exports"],[7,31,102,0],[8,4,102,0,"enumerable"],[8,14,102,0],[9,4,102,0,"get"],[9,7,102,0],[9,18,102,0,"get"],[9,19,102,0],[10,6,102,0],[10,13,102,9,"SENTRY_BUFFER_FULL_ERROR"],[10,37,102,33],[11,4,102,33],[12,2,102,33],[13,2,102,0,"Object"],[13,8,102,0],[13,9,102,0,"defineProperty"],[13,23,102,0],[13,24,102,0,"exports"],[13,31,102,0],[14,4,102,0,"enumerable"],[14,14,102,0],[15,4,102,0,"get"],[15,7,102,0],[15,18,102,0,"get"],[15,19,102,0],[16,6,102,0],[16,13,102,35,"makePromiseBuffer"],[16,30,102,52],[17,4,102,52],[18,2,102,52],[19,2,1,0],[19,6,1,0,"_syncpromiseJs"],[19,20,1,0],[19,23,1,0,"require"],[19,30,1,0],[19,31,1,0,"_dependencyMap"],[19,45,1,0],[20,2,3,0],[20,8,3,6,"SENTRY_BUFFER_FULL_ERROR"],[20,32,3,30],[20,35,3,33,"Symbol"],[20,41,3,39],[20,42,3,40,"for"],[20,45,3,43],[20,46,3,44],[20,69,3,67],[20,70,3,68],[22,2,5,0],[23,0,6,0],[24,0,7,0],[25,0,8,0],[26,2,9,0],[26,11,9,9,"makePromiseBuffer"],[26,28,9,26,"makePromiseBuffer"],[26,29,9,27,"limit"],[26,34,9,32],[26,36,9,34],[27,4,10,2],[27,10,10,8,"buffer"],[27,16,10,14],[27,19,10,17],[27,21,10,19],[28,4,12,2],[28,13,12,11,"isReady"],[28,20,12,18,"isReady"],[28,21,12,18],[28,23,12,21],[29,6,13,4],[29,13,13,11,"limit"],[29,18,13,16],[29,23,13,21,"undefined"],[29,32,13,30],[29,36,13,34,"buffer"],[29,42,13,40],[29,43,13,41,"length"],[29,49,13,47],[29,52,13,50,"limit"],[29,57,13,55],[30,4,14,2],[32,4,16,2],[33,0,17,0],[34,0,18,0],[35,0,19,0],[36,0,20,0],[37,0,21,0],[38,4,22,2],[38,13,22,11,"remove"],[38,19,22,17,"remove"],[38,20,22,18,"task"],[38,24,22,22],[38,26,22,24],[39,6,23,4],[39,13,23,11,"buffer"],[39,19,23,17],[39,20,23,18,"splice"],[39,26,23,24],[39,27,23,25,"buffer"],[39,33,23,31],[39,34,23,32,"indexOf"],[39,41,23,39],[39,42,23,40,"task"],[39,46,23,44],[39,47,23,45],[39,49,23,47],[39,50,23,48],[39,51,23,49],[39,52,23,50],[39,53,23,51],[39,54,23,52],[39,58,23,56,"Promise"],[39,65,23,63],[39,66,23,64,"resolve"],[39,73,23,71],[39,74,23,72,"undefined"],[39,83,23,81],[39,84,23,82],[40,4,24,2],[42,4,26,2],[43,0,27,0],[44,0,28,0],[45,0,29,0],[46,0,30,0],[47,0,31,0],[48,0,32,0],[49,0,33,0],[50,0,34,0],[51,0,35,0],[52,4,36,2],[52,13,36,11,"add"],[52,16,36,14,"add"],[52,17,36,15,"taskProducer"],[52,29,36,27],[52,31,36,29],[53,6,37,4],[53,10,37,8],[53,11,37,9,"isReady"],[53,18,37,16],[53,19,37,17],[53,20,37,18],[53,22,37,20],[54,8,38,6],[54,15,38,13],[54,19,38,13,"rejectedSyncPromise"],[54,33,38,32],[54,34,38,32,"rejectedSyncPromise"],[54,53,38,32],[54,55,38,33,"SENTRY_BUFFER_FULL_ERROR"],[54,79,38,57],[54,80,38,58],[55,6,39,4],[57,6,41,4],[58,6,42,4],[58,12,42,10,"task"],[58,16,42,14],[58,19,42,17,"taskProducer"],[58,31,42,29],[58,32,42,30],[58,33,42,31],[59,6,43,4],[59,10,43,8,"buffer"],[59,16,43,14],[59,17,43,15,"indexOf"],[59,24,43,22],[59,25,43,23,"task"],[59,29,43,27],[59,30,43,28],[59,35,43,33],[59,36,43,34],[59,37,43,35],[59,39,43,37],[60,8,44,6,"buffer"],[60,14,44,12],[60,15,44,13,"push"],[60,19,44,17],[60,20,44,18,"task"],[60,24,44,22],[60,25,44,23],[61,6,45,4],[62,6,46,4],[62,11,46,9,"task"],[62,15,46,13],[62,16,47,7,"then"],[62,20,47,11],[62,21,47,12],[62,27,47,18,"remove"],[62,33,47,24],[62,34,47,25,"task"],[62,38,47,29],[62,39,47,30],[63,6,48,6],[64,6,49,6],[65,6,50,6],[66,6,50,6],[66,7,51,7,"then"],[66,11,51,11],[66,12,51,12],[66,16,51,16],[66,18,51,18],[66,24,52,8,"remove"],[66,30,52,14],[66,31,52,15,"task"],[66,35,52,19],[66,36,52,20],[66,37,52,21,"then"],[66,41,52,25],[66,42,52,26],[66,46,52,30],[66,48,52,32],[66,54,52,38],[67,8,53,10],[68,6,53,10],[68,7,54,9],[68,8,55,6],[68,9,55,7],[69,6,56,4],[69,13,56,11,"task"],[69,17,56,15],[70,4,57,2],[72,4,59,2],[73,0,60,0],[74,0,61,0],[75,0,62,0],[76,0,63,0],[77,0,64,0],[78,0,65,0],[79,0,66,0],[80,0,67,0],[81,4,68,2],[81,13,68,11,"drain"],[81,18,68,16,"drain"],[81,19,68,17,"timeout"],[81,26,68,24],[81,28,68,26],[82,6,69,4],[82,13,69,11],[82,17,69,15,"SyncPromise"],[82,31,69,26],[82,32,69,26,"SyncPromise"],[82,43,69,26],[82,44,69,27],[82,45,69,28,"resolve"],[82,52,69,35],[82,54,69,37,"reject"],[82,60,69,43],[82,65,69,48],[83,8,70,6],[83,12,70,10,"counter"],[83,19,70,17],[83,22,70,20,"buffer"],[83,28,70,26],[83,29,70,27,"length"],[83,35,70,33],[84,8,72,6],[84,12,72,10],[84,13,72,11,"counter"],[84,20,72,18],[84,22,72,20],[85,10,73,8],[85,17,73,15,"resolve"],[85,24,73,22],[85,25,73,23],[85,29,73,27],[85,30,73,28],[86,8,74,6],[88,8,76,6],[89,8,77,6],[89,14,77,12,"capturedSetTimeout"],[89,32,77,30],[89,35,77,33,"setTimeout"],[89,45,77,43],[89,46,77,44],[89,52,77,50],[90,10,78,8],[90,14,78,12,"timeout"],[90,21,78,19],[90,25,78,23,"timeout"],[90,32,78,30],[90,35,78,33],[90,36,78,34],[90,38,78,36],[91,12,79,10,"resolve"],[91,19,79,17],[91,20,79,18],[91,25,79,23],[91,26,79,24],[92,10,80,8],[93,8,81,6],[93,9,81,7],[93,11,81,9,"timeout"],[93,18,81,16],[93,19,81,17],[95,8,83,6],[96,8,84,6,"buffer"],[96,14,84,12],[96,15,84,13,"forEach"],[96,22,84,20],[96,23,84,21,"item"],[96,27,84,25],[96,31,84,29],[97,10,85,8],[97,15,85,13],[97,19,85,13,"resolvedSyncPromise"],[97,33,85,32],[97,34,85,32,"resolvedSyncPromise"],[97,53,85,32],[97,55,85,33,"item"],[97,59,85,37],[97,60,85,38],[97,61,85,39,"then"],[97,65,85,43],[97,66,85,44],[97,72,85,50],[98,12,86,10],[98,16,86,14],[98,17,86,15],[98,20,86,17,"counter"],[98,27,86,24],[98,29,86,26],[99,14,87,12,"clearTimeout"],[99,26,87,24],[99,27,87,25,"capturedSetTimeout"],[99,45,87,43],[99,46,87,44],[100,14,88,12,"resolve"],[100,21,88,19],[100,22,88,20],[100,26,88,24],[100,27,88,25],[101,12,89,10],[102,10,90,8],[102,11,90,9],[102,13,90,11,"reject"],[102,19,90,17],[102,20,90,18],[103,8,91,6],[103,9,91,7],[103,10,91,8],[104,6,92,4],[104,7,92,5],[104,8,92,6],[105,4,93,2],[106,4,95,2],[106,11,95,9],[107,6,96,4,"$"],[107,7,96,5],[107,9,96,7,"buffer"],[107,15,96,13],[108,6,97,4,"add"],[108,9,97,7],[109,6,98,4,"drain"],[110,4,99,2],[110,5,99,3],[111,2,100,0],[112,0,100,1],[112,3]],"functionMap":{"names":["<global>","makePromiseBuffer","isReady","remove","add","task.then$argument_0","task.then.then$argument_1","remove.then$argument_1","drain","SyncPromise$argument_0","setTimeout$argument_0","buffer.forEach$argument_0","resolvedSyncPromise.then$argument_0"],"mappings":"AAA;ACQ;ECG;GDE;EEQ;GFE;EGY;YCW,kBD;kBEI;gCCC;SDE,CF;GHG;EOW;2BCC;4CCQ;ODI;qBEG;4CCC;SDK;OFC;KDC;GPC;CDO"},"hasCjsExports":false},"type":"js/module"}]}