{"dependencies":[{"name":"../ai/gen-ai-attributes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":119,"index":119}}],"key":"nKHaXfEjIYF1icPUCGJgR0o1cZ8=","exportNames":["*"],"imports":1}},{"name":"./constants.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":120},"end":{"line":2,"column":49,"index":169}}],"key":"46QfplZMuoT7/1B4GqMDknw8q/g=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"_INTERNAL_cleanupToolCallSpan\", {\n    enumerable: true,\n    get: function () {\n      return _INTERNAL_cleanupToolCallSpan;\n    }\n  });\n  Object.defineProperty(exports, \"_INTERNAL_getSpanForToolCallId\", {\n    enumerable: true,\n    get: function () {\n      return _INTERNAL_getSpanForToolCallId;\n    }\n  });\n  Object.defineProperty(exports, \"accumulateTokensForParent\", {\n    enumerable: true,\n    get: function () {\n      return accumulateTokensForParent;\n    }\n  });\n  Object.defineProperty(exports, \"applyAccumulatedTokens\", {\n    enumerable: true,\n    get: function () {\n      return applyAccumulatedTokens;\n    }\n  });\n  var _aiGenAiAttributesJs = require(_dependencyMap[0], \"../ai/gen-ai-attributes.js\");\n  var _constantsJs = require(_dependencyMap[1], \"./constants.js\");\n  /**\n   * Accumulates token data from a span to its parent in the token accumulator map.\n   * This function extracts token usage from the current span and adds it to the\n   * accumulated totals for its parent span.\n   */\n  function accumulateTokensForParent(span, tokenAccumulator) {\n    const parentSpanId = span.parent_span_id;\n    if (!parentSpanId) {\n      return;\n    }\n    const inputTokens = span.data[_aiGenAiAttributesJs.GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE];\n    const outputTokens = span.data[_aiGenAiAttributesJs.GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE];\n    if (typeof inputTokens === 'number' || typeof outputTokens === 'number') {\n      const existing = tokenAccumulator.get(parentSpanId) || {\n        inputTokens: 0,\n        outputTokens: 0\n      };\n      if (typeof inputTokens === 'number') {\n        existing.inputTokens += inputTokens;\n      }\n      if (typeof outputTokens === 'number') {\n        existing.outputTokens += outputTokens;\n      }\n      tokenAccumulator.set(parentSpanId, existing);\n    }\n  }\n\n  /**\n   * Applies accumulated token data to the `gen_ai.invoke_agent` span.\n   * Only immediate children of the `gen_ai.invoke_agent` span are considered,\n   * since aggregation will automatically occur for each parent span.\n   */\n  function applyAccumulatedTokens(spanOrTrace, tokenAccumulator) {\n    const accumulated = tokenAccumulator.get(spanOrTrace.span_id);\n    if (!accumulated || !spanOrTrace.data) {\n      return;\n    }\n    if (accumulated.inputTokens > 0) {\n      spanOrTrace.data[_aiGenAiAttributesJs.GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE] = accumulated.inputTokens;\n    }\n    if (accumulated.outputTokens > 0) {\n      spanOrTrace.data[_aiGenAiAttributesJs.GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE] = accumulated.outputTokens;\n    }\n    if (accumulated.inputTokens > 0 || accumulated.outputTokens > 0) {\n      spanOrTrace.data['gen_ai.usage.total_tokens'] = accumulated.inputTokens + accumulated.outputTokens;\n    }\n  }\n\n  /**\n   * Get the span associated with a tool call ID\n   */\n  function _INTERNAL_getSpanForToolCallId(toolCallId) {\n    return _constantsJs.toolCallSpanMap.get(toolCallId);\n  }\n\n  /**\n   * Clean up the span mapping for a tool call ID\n   */\n  function _INTERNAL_cleanupToolCallSpan(toolCallId) {\n    _constantsJs.toolCallSpanMap.delete(toolCallId);\n  }\n});","lineCount":94,"map":[[7,2,71,0,"Object"],[7,8,71,0],[7,9,71,0,"defineProperty"],[7,23,71,0],[7,24,71,0,"exports"],[7,31,71,0],[8,4,71,0,"enumerable"],[8,14,71,0],[9,4,71,0,"get"],[9,7,71,0],[9,18,71,0,"get"],[9,19,71,0],[10,6,71,0],[10,13,71,9,"_INTERNAL_cleanupToolCallSpan"],[10,42,71,38],[11,4,71,38],[12,2,71,38],[13,2,71,0,"Object"],[13,8,71,0],[13,9,71,0,"defineProperty"],[13,23,71,0],[13,24,71,0,"exports"],[13,31,71,0],[14,4,71,0,"enumerable"],[14,14,71,0],[15,4,71,0,"get"],[15,7,71,0],[15,18,71,0,"get"],[15,19,71,0],[16,6,71,0],[16,13,71,40,"_INTERNAL_getSpanForToolCallId"],[16,43,71,70],[17,4,71,70],[18,2,71,70],[19,2,71,0,"Object"],[19,8,71,0],[19,9,71,0,"defineProperty"],[19,23,71,0],[19,24,71,0,"exports"],[19,31,71,0],[20,4,71,0,"enumerable"],[20,14,71,0],[21,4,71,0,"get"],[21,7,71,0],[21,18,71,0,"get"],[21,19,71,0],[22,6,71,0],[22,13,71,72,"accumulateTokensForParent"],[22,38,71,97],[23,4,71,97],[24,2,71,97],[25,2,71,0,"Object"],[25,8,71,0],[25,9,71,0,"defineProperty"],[25,23,71,0],[25,24,71,0,"exports"],[25,31,71,0],[26,4,71,0,"enumerable"],[26,14,71,0],[27,4,71,0,"get"],[27,7,71,0],[27,18,71,0,"get"],[27,19,71,0],[28,6,71,0],[28,13,71,99,"applyAccumulatedTokens"],[28,35,71,121],[29,4,71,121],[30,2,71,121],[31,2,1,0],[31,6,1,0,"_aiGenAiAttributesJs"],[31,26,1,0],[31,29,1,0,"require"],[31,36,1,0],[31,37,1,0,"_dependencyMap"],[31,51,1,0],[32,2,2,0],[32,6,2,0,"_constantsJs"],[32,18,2,0],[32,21,2,0,"require"],[32,28,2,0],[32,29,2,0,"_dependencyMap"],[32,43,2,0],[33,2,4,0],[34,0,5,0],[35,0,6,0],[36,0,7,0],[37,0,8,0],[38,2,9,0],[38,11,9,9,"accumulateTokensForParent"],[38,36,9,34,"accumulateTokensForParent"],[38,37,9,35,"span"],[38,41,9,39],[38,43,9,41,"tokenAccumulator"],[38,59,9,57],[38,61,9,59],[39,4,10,2],[39,10,10,8,"parentSpanId"],[39,22,10,20],[39,25,10,23,"span"],[39,29,10,27],[39,30,10,28,"parent_span_id"],[39,44,10,42],[40,4,11,2],[40,8,11,6],[40,9,11,7,"parentSpanId"],[40,21,11,19],[40,23,11,21],[41,6,12,4],[42,4,13,2],[43,4,15,2],[43,10,15,8,"inputTokens"],[43,21,15,19],[43,24,15,22,"span"],[43,28,15,26],[43,29,15,27,"data"],[43,33,15,31],[43,34,15,32,"GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE"],[43,54,15,67],[43,55,15,67,"GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE"],[43,90,15,67],[43,91,15,68],[44,4,16,2],[44,10,16,8,"outputTokens"],[44,22,16,20],[44,25,16,23,"span"],[44,29,16,27],[44,30,16,28,"data"],[44,34,16,32],[44,35,16,33,"GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE"],[44,55,16,69],[44,56,16,69,"GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE"],[44,92,16,69],[44,93,16,70],[45,4,18,2],[45,8,18,6],[45,15,18,13,"inputTokens"],[45,26,18,24],[45,31,18,29],[45,39,18,37],[45,43,18,41],[45,50,18,48,"outputTokens"],[45,62,18,60],[45,67,18,65],[45,75,18,73],[45,77,18,75],[46,6,19,4],[46,12,19,10,"existing"],[46,20,19,18],[46,23,19,21,"tokenAccumulator"],[46,39,19,37],[46,40,19,38,"get"],[46,43,19,41],[46,44,19,42,"parentSpanId"],[46,56,19,54],[46,57,19,55],[46,61,19,59],[47,8,19,61,"inputTokens"],[47,19,19,72],[47,21,19,74],[47,22,19,75],[48,8,19,77,"outputTokens"],[48,20,19,89],[48,22,19,91],[49,6,19,93],[49,7,19,94],[50,6,21,4],[50,10,21,8],[50,17,21,15,"inputTokens"],[50,28,21,26],[50,33,21,31],[50,41,21,39],[50,43,21,41],[51,8,22,6,"existing"],[51,16,22,14],[51,17,22,15,"inputTokens"],[51,28,22,26],[51,32,22,30,"inputTokens"],[51,43,22,41],[52,6,23,4],[53,6,24,4],[53,10,24,8],[53,17,24,15,"outputTokens"],[53,29,24,27],[53,34,24,32],[53,42,24,40],[53,44,24,42],[54,8,25,6,"existing"],[54,16,25,14],[54,17,25,15,"outputTokens"],[54,29,25,27],[54,33,25,31,"outputTokens"],[54,45,25,43],[55,6,26,4],[56,6,28,4,"tokenAccumulator"],[56,22,28,20],[56,23,28,21,"set"],[56,26,28,24],[56,27,28,25,"parentSpanId"],[56,39,28,37],[56,41,28,39,"existing"],[56,49,28,47],[56,50,28,48],[57,4,29,2],[58,2,30,0],[60,2,32,0],[61,0,33,0],[62,0,34,0],[63,0,35,0],[64,0,36,0],[65,2,37,0],[65,11,37,9,"applyAccumulatedTokens"],[65,33,37,31,"applyAccumulatedTokens"],[65,34,38,2,"spanOrTrace"],[65,45,38,13],[65,47,39,2,"tokenAccumulator"],[65,63,39,18],[65,65,40,2],[66,4,41,2],[66,10,41,8,"accumulated"],[66,21,41,19],[66,24,41,22,"tokenAccumulator"],[66,40,41,38],[66,41,41,39,"get"],[66,44,41,42],[66,45,41,43,"spanOrTrace"],[66,56,41,54],[66,57,41,55,"span_id"],[66,64,41,62],[66,65,41,63],[67,4,42,2],[67,8,42,6],[67,9,42,7,"accumulated"],[67,20,42,18],[67,24,42,22],[67,25,42,23,"spanOrTrace"],[67,36,42,34],[67,37,42,35,"data"],[67,41,42,39],[67,43,42,41],[68,6,43,4],[69,4,44,2],[70,4,46,2],[70,8,46,6,"accumulated"],[70,19,46,17],[70,20,46,18,"inputTokens"],[70,31,46,29],[70,34,46,32],[70,35,46,33],[70,37,46,35],[71,6,47,4,"spanOrTrace"],[71,17,47,15],[71,18,47,16,"data"],[71,22,47,20],[71,23,47,21,"GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE"],[71,43,47,56],[71,44,47,56,"GEN_AI_USAGE_INPUT_TOKENS_ATTRIBUTE"],[71,79,47,56],[71,80,47,57],[71,83,47,60,"accumulated"],[71,94,47,71],[71,95,47,72,"inputTokens"],[71,106,47,83],[72,4,48,2],[73,4,49,2],[73,8,49,6,"accumulated"],[73,19,49,17],[73,20,49,18,"outputTokens"],[73,32,49,30],[73,35,49,33],[73,36,49,34],[73,38,49,36],[74,6,50,4,"spanOrTrace"],[74,17,50,15],[74,18,50,16,"data"],[74,22,50,20],[74,23,50,21,"GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE"],[74,43,50,57],[74,44,50,57,"GEN_AI_USAGE_OUTPUT_TOKENS_ATTRIBUTE"],[74,80,50,57],[74,81,50,58],[74,84,50,61,"accumulated"],[74,95,50,72],[74,96,50,73,"outputTokens"],[74,108,50,85],[75,4,51,2],[76,4,52,2],[76,8,52,6,"accumulated"],[76,19,52,17],[76,20,52,18,"inputTokens"],[76,31,52,29],[76,34,52,32],[76,35,52,33],[76,39,52,37,"accumulated"],[76,50,52,48],[76,51,52,49,"outputTokens"],[76,63,52,61],[76,66,52,64],[76,67,52,65],[76,69,52,67],[77,6,53,4,"spanOrTrace"],[77,17,53,15],[77,18,53,16,"data"],[77,22,53,20],[77,23,53,21],[77,50,53,48],[77,51,53,49],[77,54,53,52,"accumulated"],[77,65,53,63],[77,66,53,64,"inputTokens"],[77,77,53,75],[77,80,53,78,"accumulated"],[77,91,53,89],[77,92,53,90,"outputTokens"],[77,104,53,102],[78,4,54,2],[79,2,55,0],[81,2,57,0],[82,0,58,0],[83,0,59,0],[84,2,60,0],[84,11,60,9,"_INTERNAL_getSpanForToolCallId"],[84,41,60,39,"_INTERNAL_getSpanForToolCallId"],[84,42,60,40,"toolCallId"],[84,52,60,50],[84,54,60,52],[85,4,61,2],[85,11,61,9,"toolCallSpanMap"],[85,23,61,24],[85,24,61,24,"toolCallSpanMap"],[85,39,61,24],[85,40,61,25,"get"],[85,43,61,28],[85,44,61,29,"toolCallId"],[85,54,61,39],[85,55,61,40],[86,2,62,0],[88,2,64,0],[89,0,65,0],[90,0,66,0],[91,2,67,0],[91,11,67,9,"_INTERNAL_cleanupToolCallSpan"],[91,40,67,38,"_INTERNAL_cleanupToolCallSpan"],[91,41,67,39,"toolCallId"],[91,51,67,49],[91,53,67,51],[92,4,68,2,"toolCallSpanMap"],[92,16,68,17],[92,17,68,17,"toolCallSpanMap"],[92,32,68,17],[92,33,68,18,"delete"],[92,39,68,24],[92,40,68,25,"toolCallId"],[92,50,68,35],[92,51,68,36],[93,2,69,0],[94,0,69,1],[94,3]],"functionMap":{"names":["<global>","accumulateTokensForParent","applyAccumulatedTokens","_INTERNAL_getSpanForToolCallId","_INTERNAL_cleanupToolCallSpan"],"mappings":"AAA;ACQ;CDqB;AEO;CFkB;AGK;CHE;AIK;CJE"},"hasCjsExports":false},"type":"js/module"}]}