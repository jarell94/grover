{"dependencies":[{"name":"../../currentScopes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":51,"index":51}}],"key":"wyofRZtYR2H2+OElRwz4anlbKJw=","exportNames":["*"],"imports":1}},{"name":"../../tracing/spanstatus.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":52},"end":{"line":2,"column":64,"index":116}}],"key":"xTnLe4eZ8UwJZsOO8L+5TFoq+AE=","exportNames":["*"],"imports":1}},{"name":"./piiFiltering.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":117},"end":{"line":3,"column":61,"index":178}}],"key":"g8Iorv1/7lRJCYn1bQz8ezoQumo=","exportNames":["*"],"imports":1}},{"name":"./resultExtraction.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":179},"end":{"line":4,"column":99,"index":278}}],"key":"9tSfyC9Xqnyu5xaUHnRnNhIZQoE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"cleanupPendingSpansForTransport\", {\n    enumerable: true,\n    get: function () {\n      return cleanupPendingSpansForTransport;\n    }\n  });\n  Object.defineProperty(exports, \"completeSpanWithResults\", {\n    enumerable: true,\n    get: function () {\n      return completeSpanWithResults;\n    }\n  });\n  Object.defineProperty(exports, \"storeSpanForRequest\", {\n    enumerable: true,\n    get: function () {\n      return storeSpanForRequest;\n    }\n  });\n  var _currentScopesJs = require(_dependencyMap[0], \"../../currentScopes.js\");\n  var _tracingSpanstatusJs = require(_dependencyMap[1], \"../../tracing/spanstatus.js\");\n  var _piiFilteringJs = require(_dependencyMap[2], \"./piiFiltering.js\");\n  var _resultExtractionJs = require(_dependencyMap[3], \"./resultExtraction.js\");\n  /**\n   * Request-span correlation system for MCP server instrumentation\n   *\n   * Handles mapping requestId to span data for correlation with handler execution.\n   * Uses WeakMap to scope correlation maps per transport instance, preventing\n   * request ID collisions between different MCP sessions.\n   */\n\n  /**\n   * Transport-scoped correlation system that prevents collisions between different MCP sessions\n   * @internal Each transport instance gets its own correlation map, eliminating request ID conflicts\n   */\n  const transportToSpanMap = new WeakMap();\n\n  /**\n   * Gets or creates the span map for a specific transport instance\n   * @internal\n   * @param transport - MCP transport instance\n   * @returns Span map for the transport\n   */\n  function getOrCreateSpanMap(transport) {\n    let spanMap = transportToSpanMap.get(transport);\n    if (!spanMap) {\n      spanMap = new Map();\n      transportToSpanMap.set(transport, spanMap);\n    }\n    return spanMap;\n  }\n\n  /**\n   * Stores span context for later correlation with handler execution\n   * @param transport - MCP transport instance\n   * @param requestId - Request identifier\n   * @param span - Active span to correlate\n   * @param method - MCP method name\n   */\n  function storeSpanForRequest(transport, requestId, span, method) {\n    const spanMap = getOrCreateSpanMap(transport);\n    spanMap.set(requestId, {\n      span,\n      method,\n      startTime: Date.now()\n    });\n  }\n\n  /**\n   * Completes span with tool results and cleans up correlation\n   * @param transport - MCP transport instance\n   * @param requestId - Request identifier\n   * @param result - Tool execution result for attribute extraction\n   */\n  function completeSpanWithResults(transport, requestId, result) {\n    const spanMap = getOrCreateSpanMap(transport);\n    const spanData = spanMap.get(requestId);\n    if (spanData) {\n      const {\n        span,\n        method\n      } = spanData;\n      if (method === 'tools/call') {\n        const rawToolAttributes = (0, _resultExtractionJs.extractToolResultAttributes)(result);\n        const client = (0, _currentScopesJs.getClient)();\n        const sendDefaultPii = Boolean(client?.getOptions().sendDefaultPii);\n        const toolAttributes = (0, _piiFilteringJs.filterMcpPiiFromSpanData)(rawToolAttributes, sendDefaultPii);\n        span.setAttributes(toolAttributes);\n      } else if (method === 'prompts/get') {\n        const rawPromptAttributes = (0, _resultExtractionJs.extractPromptResultAttributes)(result);\n        const client = (0, _currentScopesJs.getClient)();\n        const sendDefaultPii = Boolean(client?.getOptions().sendDefaultPii);\n        const promptAttributes = (0, _piiFilteringJs.filterMcpPiiFromSpanData)(rawPromptAttributes, sendDefaultPii);\n        span.setAttributes(promptAttributes);\n      }\n      span.end();\n      spanMap.delete(requestId);\n    }\n  }\n\n  /**\n   * Cleans up pending spans for a specific transport (when that transport closes)\n   * @param transport - MCP transport instance\n   */\n  function cleanupPendingSpansForTransport(transport) {\n    const spanMap = transportToSpanMap.get(transport);\n    if (spanMap) {\n      for (const [, spanData] of spanMap) {\n        spanData.span.setStatus({\n          code: _tracingSpanstatusJs.SPAN_STATUS_ERROR,\n          message: 'cancelled'\n        });\n        spanData.span.end();\n      }\n      spanMap.clear();\n    }\n  }\n});","lineCount":123,"map":[[7,2,103,0,"Object"],[7,8,103,0],[7,9,103,0,"defineProperty"],[7,23,103,0],[7,24,103,0,"exports"],[7,31,103,0],[8,4,103,0,"enumerable"],[8,14,103,0],[9,4,103,0,"get"],[9,7,103,0],[9,18,103,0,"get"],[9,19,103,0],[10,6,103,0],[10,13,103,9,"cleanupPendingSpansForTransport"],[10,44,103,40],[11,4,103,40],[12,2,103,40],[13,2,103,0,"Object"],[13,8,103,0],[13,9,103,0,"defineProperty"],[13,23,103,0],[13,24,103,0,"exports"],[13,31,103,0],[14,4,103,0,"enumerable"],[14,14,103,0],[15,4,103,0,"get"],[15,7,103,0],[15,18,103,0,"get"],[15,19,103,0],[16,6,103,0],[16,13,103,42,"completeSpanWithResults"],[16,36,103,65],[17,4,103,65],[18,2,103,65],[19,2,103,0,"Object"],[19,8,103,0],[19,9,103,0,"defineProperty"],[19,23,103,0],[19,24,103,0,"exports"],[19,31,103,0],[20,4,103,0,"enumerable"],[20,14,103,0],[21,4,103,0,"get"],[21,7,103,0],[21,18,103,0,"get"],[21,19,103,0],[22,6,103,0],[22,13,103,67,"storeSpanForRequest"],[22,32,103,86],[23,4,103,86],[24,2,103,86],[25,2,1,0],[25,6,1,0,"_currentScopesJs"],[25,22,1,0],[25,25,1,0,"require"],[25,32,1,0],[25,33,1,0,"_dependencyMap"],[25,47,1,0],[26,2,2,0],[26,6,2,0,"_tracingSpanstatusJs"],[26,26,2,0],[26,29,2,0,"require"],[26,36,2,0],[26,37,2,0,"_dependencyMap"],[26,51,2,0],[27,2,3,0],[27,6,3,0,"_piiFilteringJs"],[27,21,3,0],[27,24,3,0,"require"],[27,31,3,0],[27,32,3,0,"_dependencyMap"],[27,46,3,0],[28,2,4,0],[28,6,4,0,"_resultExtractionJs"],[28,25,4,0],[28,28,4,0,"require"],[28,35,4,0],[28,36,4,0,"_dependencyMap"],[28,50,4,0],[29,2,6,0],[30,0,7,0],[31,0,8,0],[32,0,9,0],[33,0,10,0],[34,0,11,0],[35,0,12,0],[37,2,15,0],[38,0,16,0],[39,0,17,0],[40,0,18,0],[41,2,19,0],[41,8,19,6,"transportToSpanMap"],[41,26,19,24],[41,29,19,27],[41,33,19,31,"WeakMap"],[41,40,19,38],[41,41,19,39],[41,42,19,40],[43,2,21,0],[44,0,22,0],[45,0,23,0],[46,0,24,0],[47,0,25,0],[48,0,26,0],[49,2,27,0],[49,11,27,9,"getOrCreateSpanMap"],[49,29,27,27,"getOrCreateSpanMap"],[49,30,27,28,"transport"],[49,39,27,37],[49,41,27,39],[50,4,28,2],[50,8,28,6,"spanMap"],[50,15,28,13],[50,18,28,16,"transportToSpanMap"],[50,36,28,34],[50,37,28,35,"get"],[50,40,28,38],[50,41,28,39,"transport"],[50,50,28,48],[50,51,28,49],[51,4,29,2],[51,8,29,6],[51,9,29,7,"spanMap"],[51,16,29,14],[51,18,29,16],[52,6,30,4,"spanMap"],[52,13,30,11],[52,16,30,14],[52,20,30,18,"Map"],[52,23,30,21],[52,24,30,22],[52,25,30,23],[53,6,31,4,"transportToSpanMap"],[53,24,31,22],[53,25,31,23,"set"],[53,28,31,26],[53,29,31,27,"transport"],[53,38,31,36],[53,40,31,38,"spanMap"],[53,47,31,45],[53,48,31,46],[54,4,32,2],[55,4,33,2],[55,11,33,9,"spanMap"],[55,18,33,16],[56,2,34,0],[58,2,36,0],[59,0,37,0],[60,0,38,0],[61,0,39,0],[62,0,40,0],[63,0,41,0],[64,0,42,0],[65,2,43,0],[65,11,43,9,"storeSpanForRequest"],[65,30,43,28,"storeSpanForRequest"],[65,31,43,29,"transport"],[65,40,43,38],[65,42,43,40,"requestId"],[65,51,43,49],[65,53,43,51,"span"],[65,57,43,55],[65,59,43,57,"method"],[65,65,43,63],[65,67,43,65],[66,4,44,2],[66,10,44,8,"spanMap"],[66,17,44,15],[66,20,44,18,"getOrCreateSpanMap"],[66,38,44,36],[66,39,44,37,"transport"],[66,48,44,46],[66,49,44,47],[67,4,45,2,"spanMap"],[67,11,45,9],[67,12,45,10,"set"],[67,15,45,13],[67,16,45,14,"requestId"],[67,25,45,23],[67,27,45,25],[68,6,46,4,"span"],[68,10,46,8],[69,6,47,4,"method"],[69,12,47,10],[70,6,48,4,"startTime"],[70,15,48,13],[70,17,48,15,"Date"],[70,21,48,19],[70,22,48,20,"now"],[70,25,48,23],[70,26,48,24],[71,4,49,2],[71,5,49,3],[71,6,49,4],[72,2,50,0],[74,2,52,0],[75,0,53,0],[76,0,54,0],[77,0,55,0],[78,0,56,0],[79,0,57,0],[80,2,58,0],[80,11,58,9,"completeSpanWithResults"],[80,34,58,32,"completeSpanWithResults"],[80,35,58,33,"transport"],[80,44,58,42],[80,46,58,44,"requestId"],[80,55,58,53],[80,57,58,55,"result"],[80,63,58,61],[80,65,58,63],[81,4,59,2],[81,10,59,8,"spanMap"],[81,17,59,15],[81,20,59,18,"getOrCreateSpanMap"],[81,38,59,36],[81,39,59,37,"transport"],[81,48,59,46],[81,49,59,47],[82,4,60,2],[82,10,60,8,"spanData"],[82,18,60,16],[82,21,60,19,"spanMap"],[82,28,60,26],[82,29,60,27,"get"],[82,32,60,30],[82,33,60,31,"requestId"],[82,42,60,40],[82,43,60,41],[83,4,61,2],[83,8,61,6,"spanData"],[83,16,61,14],[83,18,61,16],[84,6,62,4],[84,12,62,10],[85,8,62,12,"span"],[85,12,62,16],[86,8,62,18,"method"],[87,6,62,25],[87,7,62,26],[87,10,62,29,"spanData"],[87,18,62,37],[88,6,64,4],[88,10,64,8,"method"],[88,16,64,14],[88,21,64,19],[88,33,64,31],[88,35,64,33],[89,8,65,6],[89,14,65,12,"rawToolAttributes"],[89,31,65,29],[89,34,65,32],[89,38,65,32,"extractToolResultAttributes"],[89,57,65,59],[89,58,65,59,"extractToolResultAttributes"],[89,85,65,59],[89,87,65,60,"result"],[89,93,65,66],[89,94,65,67],[90,8,66,6],[90,14,66,12,"client"],[90,20,66,18],[90,23,66,21],[90,27,66,21,"getClient"],[90,43,66,30],[90,44,66,30,"getClient"],[90,53,66,30],[90,55,66,31],[90,56,66,32],[91,8,67,6],[91,14,67,12,"sendDefaultPii"],[91,28,67,26],[91,31,67,29,"Boolean"],[91,38,67,36],[91,39,67,37,"client"],[91,45,67,43],[91,47,67,45,"getOptions"],[91,57,67,55],[91,58,67,56],[91,59,67,57],[91,60,67,58,"sendDefaultPii"],[91,74,67,72],[91,75,67,73],[92,8,68,6],[92,14,68,12,"toolAttributes"],[92,28,68,26],[92,31,68,29],[92,35,68,29,"filterMcpPiiFromSpanData"],[92,50,68,53],[92,51,68,53,"filterMcpPiiFromSpanData"],[92,75,68,53],[92,77,68,54,"rawToolAttributes"],[92,94,68,71],[92,96,68,73,"sendDefaultPii"],[92,110,68,87],[92,111,68,88],[93,8,70,6,"span"],[93,12,70,10],[93,13,70,11,"setAttributes"],[93,26,70,24],[93,27,70,25,"toolAttributes"],[93,41,70,39],[93,42,70,40],[94,6,71,4],[94,7,71,5],[94,13,71,11],[94,17,71,15,"method"],[94,23,71,21],[94,28,71,26],[94,41,71,39],[94,43,71,41],[95,8,72,6],[95,14,72,12,"rawPromptAttributes"],[95,33,72,31],[95,36,72,34],[95,40,72,34,"extractPromptResultAttributes"],[95,59,72,63],[95,60,72,63,"extractPromptResultAttributes"],[95,89,72,63],[95,91,72,64,"result"],[95,97,72,70],[95,98,72,71],[96,8,73,6],[96,14,73,12,"client"],[96,20,73,18],[96,23,73,21],[96,27,73,21,"getClient"],[96,43,73,30],[96,44,73,30,"getClient"],[96,53,73,30],[96,55,73,31],[96,56,73,32],[97,8,74,6],[97,14,74,12,"sendDefaultPii"],[97,28,74,26],[97,31,74,29,"Boolean"],[97,38,74,36],[97,39,74,37,"client"],[97,45,74,43],[97,47,74,45,"getOptions"],[97,57,74,55],[97,58,74,56],[97,59,74,57],[97,60,74,58,"sendDefaultPii"],[97,74,74,72],[97,75,74,73],[98,8,75,6],[98,14,75,12,"promptAttributes"],[98,30,75,28],[98,33,75,31],[98,37,75,31,"filterMcpPiiFromSpanData"],[98,52,75,55],[98,53,75,55,"filterMcpPiiFromSpanData"],[98,77,75,55],[98,79,75,56,"rawPromptAttributes"],[98,98,75,75],[98,100,75,77,"sendDefaultPii"],[98,114,75,91],[98,115,75,92],[99,8,77,6,"span"],[99,12,77,10],[99,13,77,11,"setAttributes"],[99,26,77,24],[99,27,77,25,"promptAttributes"],[99,43,77,41],[99,44,77,42],[100,6,78,4],[101,6,80,4,"span"],[101,10,80,8],[101,11,80,9,"end"],[101,14,80,12],[101,15,80,13],[101,16,80,14],[102,6,81,4,"spanMap"],[102,13,81,11],[102,14,81,12,"delete"],[102,20,81,18],[102,21,81,19,"requestId"],[102,30,81,28],[102,31,81,29],[103,4,82,2],[104,2,83,0],[106,2,85,0],[107,0,86,0],[108,0,87,0],[109,0,88,0],[110,2,89,0],[110,11,89,9,"cleanupPendingSpansForTransport"],[110,42,89,40,"cleanupPendingSpansForTransport"],[110,43,89,41,"transport"],[110,52,89,50],[110,54,89,52],[111,4,90,2],[111,10,90,8,"spanMap"],[111,17,90,15],[111,20,90,18,"transportToSpanMap"],[111,38,90,36],[111,39,90,37,"get"],[111,42,90,40],[111,43,90,41,"transport"],[111,52,90,50],[111,53,90,51],[112,4,91,2],[112,8,91,6,"spanMap"],[112,15,91,13],[112,17,91,15],[113,6,92,4],[113,11,92,9],[113,17,92,15],[113,20,92,18,"spanData"],[113,28,92,26],[113,29,92,27],[113,33,92,31,"spanMap"],[113,40,92,38],[113,42,92,40],[114,8,93,6,"spanData"],[114,16,93,14],[114,17,93,15,"span"],[114,21,93,19],[114,22,93,20,"setStatus"],[114,31,93,29],[114,32,93,30],[115,10,94,8,"code"],[115,14,94,12],[115,16,94,14,"SPAN_STATUS_ERROR"],[115,36,94,31],[115,37,94,31,"SPAN_STATUS_ERROR"],[115,54,94,31],[116,10,95,8,"message"],[116,17,95,15],[116,19,95,17],[117,8,96,6],[117,9,96,7],[117,10,96,8],[118,8,97,6,"spanData"],[118,16,97,14],[118,17,97,15,"span"],[118,21,97,19],[118,22,97,20,"end"],[118,25,97,23],[118,26,97,24],[118,27,97,25],[119,6,98,4],[120,6,99,4,"spanMap"],[120,13,99,11],[120,14,99,12,"clear"],[120,19,99,17],[120,20,99,18],[120,21,99,19],[121,4,100,2],[122,2,101,0],[123,0,101,1],[123,3]],"functionMap":{"names":["<global>","getOrCreateSpanMap","storeSpanForRequest","completeSpanWithResults","cleanupPendingSpansForTransport"],"mappings":"AAA;AC0B;CDO;AES;CFO;AGQ;CHyB;AIM;CJY"},"hasCjsExports":false},"type":"js/module"}]}