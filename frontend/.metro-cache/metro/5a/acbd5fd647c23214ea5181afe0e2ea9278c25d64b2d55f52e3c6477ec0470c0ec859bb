{"dependencies":[{"name":"./currentScopes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":67,"index":67}}],"key":"K7iI+PRtR1yDAq2Cd5P/ht8ORfQ=","exportNames":["*"],"imports":1}},{"name":"./exports.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":68},"end":{"line":2,"column":48,"index":116}}],"key":"t/+6jF6bamLhGLo72Jouy5+wt/Q=","exportNames":["*"],"imports":1}},{"name":"./semanticAttributes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":117},"end":{"line":3,"column":109,"index":226}}],"key":"/6BUdYPH9gaEicG1aM+qviDIUZE=","exportNames":["*"],"imports":1}},{"name":"./utils/object.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":227},"end":{"line":4,"column":61,"index":288}}],"key":"Mr3b16VHRX5yCRL431OMVx5iyT8=","exportNames":["*"],"imports":1}},{"name":"./utils/normalize.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":289},"end":{"line":5,"column":49,"index":338}}],"key":"eA0aotdEwNDbk3x/hlVkXJnhQwg=","exportNames":["*"],"imports":1}},{"name":"./tracing/trace.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":6,"column":0,"index":339},"end":{"line":6,"column":53,"index":392}}],"key":"Z0hO6xxcK72YpJO1GcfhCSObzfk=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"trpcMiddleware\", {\n    enumerable: true,\n    get: function () {\n      return trpcMiddleware;\n    }\n  });\n  var _currentScopesJs = require(_dependencyMap[0], \"./currentScopes.js\");\n  var _exportsJs = require(_dependencyMap[1], \"./exports.js\");\n  var _semanticAttributesJs = require(_dependencyMap[2], \"./semanticAttributes.js\");\n  var _utilsObjectJs = require(_dependencyMap[3], \"./utils/object.js\");\n  var _utilsNormalizeJs = require(_dependencyMap[4], \"./utils/normalize.js\");\n  var _tracingTraceJs = require(_dependencyMap[5], \"./tracing/trace.js\");\n  const trpcCaptureContext = {\n    mechanism: {\n      handled: false,\n      type: 'auto.rpc.trpc.middleware'\n    }\n  };\n  function captureIfError(nextResult) {\n    // TODO: Set span status based on what TRPCError was encountered\n    if (typeof nextResult === 'object' && nextResult !== null && 'ok' in nextResult && !nextResult.ok && 'error' in nextResult) {\n      (0, _exportsJs.captureException)(nextResult.error, trpcCaptureContext);\n    }\n  }\n\n  /**\n   * Sentry tRPC middleware that captures errors and creates spans for tRPC procedures.\n   */\n  function trpcMiddleware(options = {}) {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    return async function (opts) {\n      const {\n        path,\n        type,\n        next,\n        rawInput,\n        getRawInput\n      } = opts;\n      const client = (0, _currentScopesJs.getClient)();\n      const clientOptions = client?.getOptions();\n      const trpcContext = {\n        procedure_path: path,\n        procedure_type: type\n      };\n      (0, _utilsObjectJs.addNonEnumerableProperty)(trpcContext, '__sentry_override_normalization_depth__', 1 + (\n      // 1 for context.input + the normal normalization depth\n      clientOptions?.normalizeDepth ?? 5) // 5 is a sane depth\n      );\n      if (options.attachRpcInput !== undefined ? options.attachRpcInput : clientOptions?.sendDefaultPii) {\n        if (rawInput !== undefined) {\n          trpcContext.input = (0, _utilsNormalizeJs.normalize)(rawInput);\n        }\n        if (getRawInput !== undefined && typeof getRawInput === 'function') {\n          try {\n            const rawRes = await getRawInput();\n            trpcContext.input = (0, _utilsNormalizeJs.normalize)(rawRes);\n          } catch {\n            // noop\n          }\n        }\n      }\n      return (0, _currentScopesJs.withIsolationScope)(scope => {\n        scope.setContext('trpc', trpcContext);\n        return (0, _tracingTraceJs.startSpanManual)({\n          name: `trpc/${path}`,\n          op: 'rpc.server',\n          attributes: {\n            [_semanticAttributesJs.SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: 'route',\n            [_semanticAttributesJs.SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.rpc.trpc'\n          },\n          forceTransaction: !!options.forceTransaction\n        }, async span => {\n          try {\n            const nextResult = await next();\n            captureIfError(nextResult);\n            span.end();\n            return nextResult;\n          } catch (e) {\n            (0, _exportsJs.captureException)(e, trpcCaptureContext);\n            span.end();\n            throw e;\n          }\n        });\n      });\n    };\n  }\n});","lineCount":94,"map":[[7,2,92,0,"Object"],[7,8,92,0],[7,9,92,0,"defineProperty"],[7,23,92,0],[7,24,92,0,"exports"],[7,31,92,0],[8,4,92,0,"enumerable"],[8,14,92,0],[9,4,92,0,"get"],[9,7,92,0],[9,18,92,0,"get"],[9,19,92,0],[10,6,92,0],[10,13,92,9,"trpcMiddleware"],[10,27,92,23],[11,4,92,23],[12,2,92,23],[13,2,1,0],[13,6,1,0,"_currentScopesJs"],[13,22,1,0],[13,25,1,0,"require"],[13,32,1,0],[13,33,1,0,"_dependencyMap"],[13,47,1,0],[14,2,2,0],[14,6,2,0,"_exportsJs"],[14,16,2,0],[14,19,2,0,"require"],[14,26,2,0],[14,27,2,0,"_dependencyMap"],[14,41,2,0],[15,2,3,0],[15,6,3,0,"_semanticAttributesJs"],[15,27,3,0],[15,30,3,0,"require"],[15,37,3,0],[15,38,3,0,"_dependencyMap"],[15,52,3,0],[16,2,4,0],[16,6,4,0,"_utilsObjectJs"],[16,20,4,0],[16,23,4,0,"require"],[16,30,4,0],[16,31,4,0,"_dependencyMap"],[16,45,4,0],[17,2,5,0],[17,6,5,0,"_utilsNormalizeJs"],[17,23,5,0],[17,26,5,0,"require"],[17,33,5,0],[17,34,5,0,"_dependencyMap"],[17,48,5,0],[18,2,6,0],[18,6,6,0,"_tracingTraceJs"],[18,21,6,0],[18,24,6,0,"require"],[18,31,6,0],[18,32,6,0,"_dependencyMap"],[18,46,6,0],[19,2,8,0],[19,8,8,6,"trpcCaptureContext"],[19,26,8,24],[19,29,8,27],[20,4,8,29,"mechanism"],[20,13,8,38],[20,15,8,40],[21,6,8,42,"handled"],[21,13,8,49],[21,15,8,51],[21,20,8,56],[22,6,8,58,"type"],[22,10,8,62],[22,12,8,64],[23,4,8,91],[24,2,8,93],[24,3,8,94],[25,2,10,0],[25,11,10,9,"captureIfError"],[25,25,10,23,"captureIfError"],[25,26,10,24,"nextResult"],[25,36,10,34],[25,38,10,36],[26,4,11,2],[27,4,12,2],[27,8,13,4],[27,15,13,11,"nextResult"],[27,25,13,21],[27,30,13,26],[27,38,13,34],[27,42,14,4,"nextResult"],[27,52,14,14],[27,57,14,19],[27,61,14,23],[27,65,15,4],[27,69,15,8],[27,73,15,12,"nextResult"],[27,83,15,22],[27,87,16,4],[27,88,16,5,"nextResult"],[27,98,16,15],[27,99,16,16,"ok"],[27,101,16,18],[27,105,17,4],[27,112,17,11],[27,116,17,15,"nextResult"],[27,126,17,25],[27,128,18,4],[28,6,19,4],[28,10,19,4,"captureException"],[28,20,19,20],[28,21,19,20,"captureException"],[28,37,19,20],[28,39,19,21,"nextResult"],[28,49,19,31],[28,50,19,32,"error"],[28,55,19,37],[28,57,19,39,"trpcCaptureContext"],[28,75,19,57],[28,76,19,58],[29,4,20,2],[30,2,21,0],[32,2,23,0],[33,0,24,0],[34,0,25,0],[35,2,26,0],[35,11,26,9,"trpcMiddleware"],[35,25,26,23,"trpcMiddleware"],[35,26,26,24,"options"],[35,33,26,31],[35,36,26,34],[35,37,26,35],[35,38,26,36],[35,40,26,38],[36,4,27,2],[37,4,28,2],[38,4,29,2],[38,11,29,9],[38,27,29,25,"opts"],[38,31,29,29],[38,33,29,31],[39,6,30,4],[39,12,30,10],[40,8,30,12,"path"],[40,12,30,16],[41,8,30,18,"type"],[41,12,30,22],[42,8,30,24,"next"],[42,12,30,28],[43,8,30,30,"rawInput"],[43,16,30,38],[44,8,30,40,"getRawInput"],[45,6,30,52],[45,7,30,53],[45,10,30,56,"opts"],[45,14,30,60],[46,6,32,4],[46,12,32,10,"client"],[46,18,32,16],[46,21,32,19],[46,25,32,19,"getClient"],[46,41,32,28],[46,42,32,28,"getClient"],[46,51,32,28],[46,53,32,29],[46,54,32,30],[47,6,33,4],[47,12,33,10,"clientOptions"],[47,25,33,23],[47,28,33,26,"client"],[47,34,33,32],[47,36,33,34,"getOptions"],[47,46,33,44],[47,47,33,45],[47,48,33,46],[48,6,35,4],[48,12,35,10,"trpcContext"],[48,23,35,21],[48,26,35,24],[49,8,36,6,"procedure_path"],[49,22,36,20],[49,24,36,22,"path"],[49,28,36,26],[50,8,37,6,"procedure_type"],[50,22,37,20],[50,24,37,22,"type"],[51,6,38,4],[51,7,38,5],[52,6,40,4],[52,10,40,4,"addNonEnumerableProperty"],[52,24,40,28],[52,25,40,28,"addNonEnumerableProperty"],[52,49,40,28],[52,51,41,6,"trpcContext"],[52,62,41,17],[52,64,42,6],[52,105,42,47],[52,107,43,6],[52,108,43,7],[53,6,43,10],[54,6,44,9,"clientOptions"],[54,19,44,22],[54,21,44,24,"normalizeDepth"],[54,35,44,38],[54,39,44,42],[54,40,44,43],[54,41,44,44],[54,42,44,46],[55,6,45,4],[55,7,45,5],[56,6,47,4],[56,10,47,8,"options"],[56,17,47,15],[56,18,47,16,"attachRpcInput"],[56,32,47,30],[56,37,47,35,"undefined"],[56,46,47,44],[56,49,47,47,"options"],[56,56,47,54],[56,57,47,55,"attachRpcInput"],[56,71,47,69],[56,74,47,72,"clientOptions"],[56,87,47,85],[56,89,47,87,"sendDefaultPii"],[56,103,47,101],[56,105,47,103],[57,8,48,6],[57,12,48,10,"rawInput"],[57,20,48,18],[57,25,48,23,"undefined"],[57,34,48,32],[57,36,48,34],[58,10,49,8,"trpcContext"],[58,21,49,19],[58,22,49,20,"input"],[58,27,49,25],[58,30,49,28],[58,34,49,28,"normalize"],[58,51,49,37],[58,52,49,37,"normalize"],[58,61,49,37],[58,63,49,38,"rawInput"],[58,71,49,46],[58,72,49,47],[59,8,50,6],[60,8,52,6],[60,12,52,10,"getRawInput"],[60,23,52,21],[60,28,52,26,"undefined"],[60,37,52,35],[60,41,52,39],[60,48,52,46,"getRawInput"],[60,59,52,57],[60,64,52,62],[60,74,52,72],[60,76,52,74],[61,10,53,8],[61,14,53,12],[62,12,54,10],[62,18,54,16,"rawRes"],[62,24,54,22],[62,27,54,25],[62,33,54,31,"getRawInput"],[62,44,54,42],[62,45,54,43],[62,46,54,44],[63,12,56,10,"trpcContext"],[63,23,56,21],[63,24,56,22,"input"],[63,29,56,27],[63,32,56,30],[63,36,56,30,"normalize"],[63,53,56,39],[63,54,56,39,"normalize"],[63,63,56,39],[63,65,56,40,"rawRes"],[63,71,56,46],[63,72,56,47],[64,10,57,8],[64,11,57,9],[64,12,57,10],[64,18,57,16],[65,12,58,10],[66,10,58,10],[67,8,60,6],[68,6,61,4],[69,6,63,4],[69,13,63,11],[69,17,63,11,"withIsolationScope"],[69,33,63,29],[69,34,63,29,"withIsolationScope"],[69,52,63,29],[69,54,63,30,"scope"],[69,59,63,35],[69,63,63,39],[70,8,64,6,"scope"],[70,13,64,11],[70,14,64,12,"setContext"],[70,24,64,22],[70,25,64,23],[70,31,64,29],[70,33,64,31,"trpcContext"],[70,44,64,42],[70,45,64,43],[71,8,65,6],[71,15,65,13],[71,19,65,13,"startSpanManual"],[71,34,65,28],[71,35,65,28,"startSpanManual"],[71,50,65,28],[71,52,66,8],[72,10,67,10,"name"],[72,14,67,14],[72,16,67,16],[72,24,67,24,"path"],[72,28,67,28],[72,30,67,30],[73,10,68,10,"op"],[73,12,68,12],[73,14,68,14],[73,26,68,26],[74,10,69,10,"attributes"],[74,20,69,20],[74,22,69,22],[75,12,70,12],[75,13,70,13,"SEMANTIC_ATTRIBUTE_SENTRY_SOURCE"],[75,34,70,45],[75,35,70,45,"SEMANTIC_ATTRIBUTE_SENTRY_SOURCE"],[75,67,70,45],[75,70,70,48],[75,77,70,55],[76,12,71,12],[76,13,71,13,"SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN"],[76,34,71,45],[76,35,71,45,"SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN"],[76,67,71,45],[76,70,71,48],[77,10,72,10],[77,11,72,11],[78,10,73,10,"forceTransaction"],[78,26,73,26],[78,28,73,28],[78,29,73,29],[78,30,73,30,"options"],[78,37,73,37],[78,38,73,38,"forceTransaction"],[79,8,74,8],[79,9,74,9],[79,11,75,8],[79,17,75,14,"span"],[79,21,75,18],[79,25,75,22],[80,10,76,10],[80,14,76,14],[81,12,77,12],[81,18,77,18,"nextResult"],[81,28,77,28],[81,31,77,31],[81,37,77,37,"next"],[81,41,77,41],[81,42,77,42],[81,43,77,43],[82,12,78,12,"captureIfError"],[82,26,78,26],[82,27,78,27,"nextResult"],[82,37,78,37],[82,38,78,38],[83,12,79,12,"span"],[83,16,79,16],[83,17,79,17,"end"],[83,20,79,20],[83,21,79,21],[83,22,79,22],[84,12,80,12],[84,19,80,19,"nextResult"],[84,29,80,29],[85,10,81,10],[85,11,81,11],[85,12,81,12],[85,19,81,19,"e"],[85,20,81,20],[85,22,81,22],[86,12,82,12],[86,16,82,12,"captureException"],[86,26,82,28],[86,27,82,28,"captureException"],[86,43,82,28],[86,45,82,29,"e"],[86,46,82,30],[86,48,82,32,"trpcCaptureContext"],[86,66,82,50],[86,67,82,51],[87,12,83,12,"span"],[87,16,83,16],[87,17,83,17,"end"],[87,20,83,20],[87,21,83,21],[87,22,83,22],[88,12,84,12],[88,18,84,18,"e"],[88,19,84,19],[89,10,85,10],[90,8,86,8],[90,9,87,6],[90,10,87,7],[91,6,88,4],[91,7,88,5],[91,8,88,6],[92,4,89,2],[92,5,89,3],[93,2,90,0],[94,0,90,1],[94,3]],"functionMap":{"names":["<global>","captureIfError","trpcMiddleware","<anonymous>","withIsolationScope$argument_0","startSpanManual$argument_1"],"mappings":"AAA;ACS;CDW;AEK;SCG;8BCkC;QCY;SDW;KDE;GDC;CFC"},"hasCjsExports":false},"type":"js/module"}]}