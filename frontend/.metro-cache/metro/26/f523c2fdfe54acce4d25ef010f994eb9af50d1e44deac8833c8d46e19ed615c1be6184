{"dependencies":[{"name":"../debug-build.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":48,"index":48}}],"key":"rfhktnzi6PvZxT1xtyHWbBktN/w=","exportNames":["*"],"imports":1}},{"name":"../utils/debug-logger.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":49},"end":{"line":2,"column":49,"index":98}}],"key":"bptn1GZFOkS4BOMU8jhPqqHmvAc=","exportNames":["*"],"imports":1}},{"name":"../utils/envelope.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":99},"end":{"line":3,"column":64,"index":163}}],"key":"yiniLg9hHeIHPDkrzeivR1oDz5o=","exportNames":["*"],"imports":1}},{"name":"../utils/ratelimit.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":164},"end":{"line":4,"column":62,"index":226}}],"key":"eBQc6ZZkzOf7Vfwryf2nt/LMy9M=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"MIN_DELAY\", {\n    enumerable: true,\n    get: function () {\n      return MIN_DELAY;\n    }\n  });\n  Object.defineProperty(exports, \"START_DELAY\", {\n    enumerable: true,\n    get: function () {\n      return START_DELAY;\n    }\n  });\n  Object.defineProperty(exports, \"makeOfflineTransport\", {\n    enumerable: true,\n    get: function () {\n      return makeOfflineTransport;\n    }\n  });\n  var _debugBuildJs = require(_dependencyMap[0], \"../debug-build.js\");\n  var _utilsDebugLoggerJs = require(_dependencyMap[1], \"../utils/debug-logger.js\");\n  var _utilsEnvelopeJs = require(_dependencyMap[2], \"../utils/envelope.js\");\n  var _utilsRatelimitJs = require(_dependencyMap[3], \"../utils/ratelimit.js\");\n  const MIN_DELAY = 100; // 100 ms\n  const START_DELAY = 5000; // 5 seconds\n  const MAX_DELAY = 3.6e6; // 1 hour\n\n  /**\n   * Wraps a transport and stores and retries events when they fail to send.\n   *\n   * @param createTransport The transport to wrap.\n   */\n  function makeOfflineTransport(createTransport) {\n    function log(...args) {\n      _debugBuildJs.DEBUG_BUILD && _utilsDebugLoggerJs.debug.log('[Offline]:', ...args);\n    }\n    return options => {\n      const transport = createTransport(options);\n      if (!options.createStore) {\n        throw new Error('No `createStore` function was provided');\n      }\n      const store = options.createStore(options);\n      let retryDelay = START_DELAY;\n      let flushTimer;\n      function shouldQueue(env, error, retryDelay) {\n        // We want to drop client reports because they can be generated when we retry sending events while offline.\n        if ((0, _utilsEnvelopeJs.envelopeContainsItemType)(env, ['client_report'])) {\n          return false;\n        }\n        if (options.shouldStore) {\n          return options.shouldStore(env, error, retryDelay);\n        }\n        return true;\n      }\n      function flushIn(delay) {\n        if (flushTimer) {\n          clearTimeout(flushTimer);\n        }\n        flushTimer = setTimeout(async () => {\n          flushTimer = undefined;\n          const found = await store.shift();\n          if (found) {\n            log('Attempting to send previously queued event');\n\n            // We should to update the sent_at timestamp to the current time.\n            found[0].sent_at = new Date().toISOString();\n            void send(found, true).catch(e => {\n              log('Failed to retry sending', e);\n            });\n          }\n        }, delay);\n\n        // We need to unref the timer in node.js, otherwise the node process never exit.\n        if (typeof flushTimer !== 'number' && flushTimer.unref) {\n          flushTimer.unref();\n        }\n      }\n      function flushWithBackOff() {\n        if (flushTimer) {\n          return;\n        }\n        flushIn(retryDelay);\n        retryDelay = Math.min(retryDelay * 2, MAX_DELAY);\n      }\n      async function send(envelope, isRetry = false) {\n        // We queue all replay envelopes to avoid multiple replay envelopes being sent at the same time. If one fails, we\n        // need to retry them in order.\n        if (!isRetry && (0, _utilsEnvelopeJs.envelopeContainsItemType)(envelope, ['replay_event', 'replay_recording'])) {\n          await store.push(envelope);\n          flushIn(MIN_DELAY);\n          return {};\n        }\n        try {\n          if (options.shouldSend && (await options.shouldSend(envelope)) === false) {\n            throw new Error('Envelope not sent because `shouldSend` callback returned false');\n          }\n          const result = await transport.send(envelope);\n          let delay = MIN_DELAY;\n          if (result) {\n            // If there's a retry-after header, use that as the next delay.\n            if (result.headers?.['retry-after']) {\n              delay = (0, _utilsRatelimitJs.parseRetryAfterHeader)(result.headers['retry-after']);\n            } else if (result.headers?.['x-sentry-rate-limits']) {\n              delay = 60000; // 60 seconds\n            } // If we have a server error, return now so we don't flush the queue.\n            else if ((result.statusCode || 0) >= 400) {\n              return result;\n            }\n          }\n          flushIn(delay);\n          retryDelay = START_DELAY;\n          return result;\n        } catch (e) {\n          if (await shouldQueue(envelope, e, retryDelay)) {\n            // If this envelope was a retry, we want to add it to the front of the queue so it's retried again first.\n            if (isRetry) {\n              await store.unshift(envelope);\n            } else {\n              await store.push(envelope);\n            }\n            flushWithBackOff();\n            log('Error sending. Event queued.', e);\n            return {};\n          } else {\n            throw e;\n          }\n        }\n      }\n      if (options.flushAtStartup) {\n        flushWithBackOff();\n      }\n      return {\n        send,\n        flush: timeout => {\n          // If there's no timeout, we should attempt to flush the offline queue.\n          if (timeout === undefined) {\n            retryDelay = START_DELAY;\n            flushIn(MIN_DELAY);\n          }\n          return transport.flush(timeout);\n        }\n      };\n    };\n  }\n});","lineCount":150,"map":[[7,2,153,0,"Object"],[7,8,153,0],[7,9,153,0,"defineProperty"],[7,23,153,0],[7,24,153,0,"exports"],[7,31,153,0],[8,4,153,0,"enumerable"],[8,14,153,0],[9,4,153,0,"get"],[9,7,153,0],[9,18,153,0,"get"],[9,19,153,0],[10,6,153,0],[10,13,153,9,"MIN_DELAY"],[10,22,153,18],[11,4,153,18],[12,2,153,18],[13,2,153,0,"Object"],[13,8,153,0],[13,9,153,0,"defineProperty"],[13,23,153,0],[13,24,153,0,"exports"],[13,31,153,0],[14,4,153,0,"enumerable"],[14,14,153,0],[15,4,153,0,"get"],[15,7,153,0],[15,18,153,0,"get"],[15,19,153,0],[16,6,153,0],[16,13,153,20,"START_DELAY"],[16,24,153,31],[17,4,153,31],[18,2,153,31],[19,2,153,0,"Object"],[19,8,153,0],[19,9,153,0,"defineProperty"],[19,23,153,0],[19,24,153,0,"exports"],[19,31,153,0],[20,4,153,0,"enumerable"],[20,14,153,0],[21,4,153,0,"get"],[21,7,153,0],[21,18,153,0,"get"],[21,19,153,0],[22,6,153,0],[22,13,153,33,"makeOfflineTransport"],[22,33,153,53],[23,4,153,53],[24,2,153,53],[25,2,1,0],[25,6,1,0,"_debugBuildJs"],[25,19,1,0],[25,22,1,0,"require"],[25,29,1,0],[25,30,1,0,"_dependencyMap"],[25,44,1,0],[26,2,2,0],[26,6,2,0,"_utilsDebugLoggerJs"],[26,25,2,0],[26,28,2,0,"require"],[26,35,2,0],[26,36,2,0,"_dependencyMap"],[26,50,2,0],[27,2,3,0],[27,6,3,0,"_utilsEnvelopeJs"],[27,22,3,0],[27,25,3,0,"require"],[27,32,3,0],[27,33,3,0,"_dependencyMap"],[27,47,3,0],[28,2,4,0],[28,6,4,0,"_utilsRatelimitJs"],[28,23,4,0],[28,26,4,0,"require"],[28,33,4,0],[28,34,4,0,"_dependencyMap"],[28,48,4,0],[29,2,6,0],[29,8,6,6,"MIN_DELAY"],[29,17,6,15],[29,20,6,18],[29,23,6,21],[29,24,6,22],[29,25,6,23],[30,2,7,0],[30,8,7,6,"START_DELAY"],[30,19,7,17],[30,22,7,20],[30,26,7,24],[30,27,7,25],[30,28,7,26],[31,2,8,0],[31,8,8,6,"MAX_DELAY"],[31,17,8,15],[31,20,8,18],[31,25,8,23],[31,26,8,24],[31,27,8,25],[33,2,10,0],[34,0,11,0],[35,0,12,0],[36,0,13,0],[37,0,14,0],[38,2,15,0],[38,11,15,9,"makeOfflineTransport"],[38,31,15,29,"makeOfflineTransport"],[38,32,16,2,"createTransport"],[38,47,16,17],[38,49,17,2],[39,4,18,2],[39,13,18,11,"log"],[39,16,18,14,"log"],[39,17,18,15],[39,20,18,18,"args"],[39,24,18,22],[39,26,18,24],[40,6,19,4,"DEBUG_BUILD"],[40,19,19,15],[40,20,19,15,"DEBUG_BUILD"],[40,31,19,15],[40,35,19,19,"debug"],[40,54,19,24],[40,55,19,24,"debug"],[40,60,19,24],[40,61,19,25,"log"],[40,64,19,28],[40,65,19,29],[40,77,19,41],[40,79,19,43],[40,82,19,46,"args"],[40,86,19,50],[40,87,19,51],[41,4,20,2],[42,4,22,2],[42,11,22,9,"options"],[42,18,22,16],[42,22,22,20],[43,6,23,4],[43,12,23,10,"transport"],[43,21,23,19],[43,24,23,22,"createTransport"],[43,39,23,37],[43,40,23,38,"options"],[43,47,23,45],[43,48,23,46],[44,6,25,4],[44,10,25,8],[44,11,25,9,"options"],[44,18,25,16],[44,19,25,17,"createStore"],[44,30,25,28],[44,32,25,30],[45,8,26,6],[45,14,26,12],[45,18,26,16,"Error"],[45,23,26,21],[45,24,26,22],[45,64,26,62],[45,65,26,63],[46,6,27,4],[47,6,29,4],[47,12,29,10,"store"],[47,17,29,15],[47,20,29,18,"options"],[47,27,29,25],[47,28,29,26,"createStore"],[47,39,29,37],[47,40,29,38,"options"],[47,47,29,45],[47,48,29,46],[48,6,31,4],[48,10,31,8,"retryDelay"],[48,20,31,18],[48,23,31,21,"START_DELAY"],[48,34,31,32],[49,6,32,4],[49,10,32,8,"flushTimer"],[49,20,32,18],[50,6,34,4],[50,15,34,13,"shouldQueue"],[50,26,34,24,"shouldQueue"],[50,27,34,25,"env"],[50,30,34,28],[50,32,34,30,"error"],[50,37,34,35],[50,39,34,37,"retryDelay"],[50,49,34,47],[50,51,34,49],[51,8,35,6],[52,8,36,6],[52,12,36,10],[52,16,36,10,"envelopeContainsItemType"],[52,32,36,34],[52,33,36,34,"envelopeContainsItemType"],[52,57,36,34],[52,59,36,35,"env"],[52,62,36,38],[52,64,36,40],[52,65,36,41],[52,80,36,56],[52,81,36,57],[52,82,36,58],[52,84,36,60],[53,10,37,8],[53,17,37,15],[53,22,37,20],[54,8,38,6],[55,8,40,6],[55,12,40,10,"options"],[55,19,40,17],[55,20,40,18,"shouldStore"],[55,31,40,29],[55,33,40,31],[56,10,41,8],[56,17,41,15,"options"],[56,24,41,22],[56,25,41,23,"shouldStore"],[56,36,41,34],[56,37,41,35,"env"],[56,40,41,38],[56,42,41,40,"error"],[56,47,41,45],[56,49,41,47,"retryDelay"],[56,59,41,57],[56,60,41,58],[57,8,42,6],[58,8,44,6],[58,15,44,13],[58,19,44,17],[59,6,45,4],[60,6,47,4],[60,15,47,13,"flushIn"],[60,22,47,20,"flushIn"],[60,23,47,21,"delay"],[60,28,47,26],[60,30,47,28],[61,8,48,6],[61,12,48,10,"flushTimer"],[61,22,48,20],[61,24,48,22],[62,10,49,8,"clearTimeout"],[62,22,49,20],[62,23,49,21,"flushTimer"],[62,33,49,32],[62,34,49,33],[63,8,50,6],[64,8,52,6,"flushTimer"],[64,18,52,16],[64,21,52,19,"setTimeout"],[64,31,52,29],[64,32,52,30],[64,44,52,42],[65,10,53,8,"flushTimer"],[65,20,53,18],[65,23,53,21,"undefined"],[65,32,53,30],[66,10,55,8],[66,16,55,14,"found"],[66,21,55,19],[66,24,55,22],[66,30,55,28,"store"],[66,35,55,33],[66,36,55,34,"shift"],[66,41,55,39],[66,42,55,40],[66,43,55,41],[67,10,56,8],[67,14,56,12,"found"],[67,19,56,17],[67,21,56,19],[68,12,57,10,"log"],[68,15,57,13],[68,16,57,14],[68,60,57,58],[68,61,57,59],[70,12,59,10],[71,12,60,10,"found"],[71,17,60,15],[71,18,60,16],[71,19,60,17],[71,20,60,18],[71,21,60,19,"sent_at"],[71,28,60,26],[71,31,60,29],[71,35,60,33,"Date"],[71,39,60,37],[71,40,60,38],[71,41,60,39],[71,42,60,40,"toISOString"],[71,53,60,51],[71,54,60,52],[71,55,60,53],[72,12,62,10],[72,17,62,15,"send"],[72,21,62,19],[72,22,62,20,"found"],[72,27,62,25],[72,29,62,27],[72,33,62,31],[72,34,62,32],[72,35,62,33,"catch"],[72,40,62,38],[72,41,62,39,"e"],[72,42,62,40],[72,46,62,44],[73,14,63,12,"log"],[73,17,63,15],[73,18,63,16],[73,43,63,41],[73,45,63,43,"e"],[73,46,63,44],[73,47,63,45],[74,12,64,10],[74,13,64,11],[74,14,64,12],[75,10,65,8],[76,8,66,6],[76,9,66,7],[76,11,66,9,"delay"],[76,16,66,14],[76,17,66,15],[78,8,68,6],[79,8,69,6],[79,12,69,10],[79,19,69,17,"flushTimer"],[79,29,69,27],[79,34,69,32],[79,42,69,40],[79,46,69,44,"flushTimer"],[79,56,69,54],[79,57,69,55,"unref"],[79,62,69,60],[79,64,69,62],[80,10,70,8,"flushTimer"],[80,20,70,18],[80,21,70,19,"unref"],[80,26,70,24],[80,27,70,25],[80,28,70,26],[81,8,71,6],[82,6,72,4],[83,6,74,4],[83,15,74,13,"flushWithBackOff"],[83,31,74,29,"flushWithBackOff"],[83,32,74,29],[83,34,74,32],[84,8,75,6],[84,12,75,10,"flushTimer"],[84,22,75,20],[84,24,75,22],[85,10,76,8],[86,8,77,6],[87,8,79,6,"flushIn"],[87,15,79,13],[87,16,79,14,"retryDelay"],[87,26,79,24],[87,27,79,25],[88,8,81,6,"retryDelay"],[88,18,81,16],[88,21,81,19,"Math"],[88,25,81,23],[88,26,81,24,"min"],[88,29,81,27],[88,30,81,28,"retryDelay"],[88,40,81,38],[88,43,81,41],[88,44,81,42],[88,46,81,44,"MAX_DELAY"],[88,55,81,53],[88,56,81,54],[89,6,82,4],[90,6,84,4],[90,21,84,19,"send"],[90,25,84,23,"send"],[90,26,84,24,"envelope"],[90,34,84,32],[90,36,84,34,"isRetry"],[90,43,84,41],[90,46,84,44],[90,51,84,49],[90,53,84,51],[91,8,85,6],[92,8,86,6],[93,8,87,6],[93,12,87,10],[93,13,87,11,"isRetry"],[93,20,87,18],[93,24,87,22],[93,28,87,22,"envelopeContainsItemType"],[93,44,87,46],[93,45,87,46,"envelopeContainsItemType"],[93,69,87,46],[93,71,87,47,"envelope"],[93,79,87,55],[93,81,87,57],[93,82,87,58],[93,96,87,72],[93,98,87,74],[93,116,87,92],[93,117,87,93],[93,118,87,94],[93,120,87,96],[94,10,88,8],[94,16,88,14,"store"],[94,21,88,19],[94,22,88,20,"push"],[94,26,88,24],[94,27,88,25,"envelope"],[94,35,88,33],[94,36,88,34],[95,10,89,8,"flushIn"],[95,17,89,15],[95,18,89,16,"MIN_DELAY"],[95,27,89,25],[95,28,89,26],[96,10,90,8],[96,17,90,15],[96,18,90,16],[96,19,90,17],[97,8,91,6],[98,8,93,6],[98,12,93,10],[99,10,94,8],[99,14,94,12,"options"],[99,21,94,19],[99,22,94,20,"shouldSend"],[99,32,94,30],[99,36,94,34],[99,37,94,35],[99,43,94,41,"options"],[99,50,94,48],[99,51,94,49,"shouldSend"],[99,61,94,59],[99,62,94,60,"envelope"],[99,70,94,68],[99,71,94,69],[99,77,94,75],[99,82,94,80],[99,84,94,82],[100,12,95,10],[100,18,95,16],[100,22,95,20,"Error"],[100,27,95,25],[100,28,95,26],[100,92,95,90],[100,93,95,91],[101,10,96,8],[102,10,98,8],[102,16,98,14,"result"],[102,22,98,20],[102,25,98,23],[102,31,98,29,"transport"],[102,40,98,38],[102,41,98,39,"send"],[102,45,98,43],[102,46,98,44,"envelope"],[102,54,98,52],[102,55,98,53],[103,10,100,8],[103,14,100,12,"delay"],[103,19,100,17],[103,22,100,20,"MIN_DELAY"],[103,31,100,29],[104,10,102,8],[104,14,102,12,"result"],[104,20,102,18],[104,22,102,20],[105,12,103,10],[106,12,104,10],[106,16,104,14,"result"],[106,22,104,20],[106,23,104,21,"headers"],[106,30,104,28],[106,33,104,31],[106,46,104,44],[106,47,104,45],[106,49,104,47],[107,14,105,12,"delay"],[107,19,105,17],[107,22,105,20],[107,26,105,20,"parseRetryAfterHeader"],[107,43,105,41],[107,44,105,41,"parseRetryAfterHeader"],[107,65,105,41],[107,67,105,42,"result"],[107,73,105,48],[107,74,105,49,"headers"],[107,81,105,56],[107,82,105,57],[107,95,105,70],[107,96,105,71],[107,97,105,72],[108,12,106,10],[108,13,106,11],[108,19,106,17],[108,23,106,21,"result"],[108,29,106,27],[108,30,106,28,"headers"],[108,37,106,35],[108,40,106,38],[108,62,106,60],[108,63,106,61],[108,65,106,63],[109,14,107,12,"delay"],[109,19,107,17],[109,22,107,20],[109,27,107,25],[109,28,107,26],[109,29,107,27],[110,12,108,10],[110,13,108,11],[110,14,108,12],[111,12,108,12],[111,17,109,15],[111,21,109,19],[111,22,109,20,"result"],[111,28,109,26],[111,29,109,27,"statusCode"],[111,39,109,37],[111,43,109,41],[111,44,109,42],[111,49,109,47],[111,52,109,50],[111,54,109,52],[112,14,110,12],[112,21,110,19,"result"],[112,27,110,25],[113,12,111,10],[114,10,112,8],[115,10,114,8,"flushIn"],[115,17,114,15],[115,18,114,16,"delay"],[115,23,114,21],[115,24,114,22],[116,10,115,8,"retryDelay"],[116,20,115,18],[116,23,115,21,"START_DELAY"],[116,34,115,32],[117,10,116,8],[117,17,116,15,"result"],[117,23,116,21],[118,8,117,6],[118,9,117,7],[118,10,117,8],[118,17,117,15,"e"],[118,18,117,16],[118,20,117,18],[119,10,118,8],[119,14,118,12],[119,20,118,18,"shouldQueue"],[119,31,118,29],[119,32,118,30,"envelope"],[119,40,118,38],[119,42,118,40,"e"],[119,43,118,41],[119,45,118,44,"retryDelay"],[119,55,118,54],[119,56,118,55],[119,58,118,57],[120,12,119,10],[121,12,120,10],[121,16,120,14,"isRetry"],[121,23,120,21],[121,25,120,23],[122,14,121,12],[122,20,121,18,"store"],[122,25,121,23],[122,26,121,24,"unshift"],[122,33,121,31],[122,34,121,32,"envelope"],[122,42,121,40],[122,43,121,41],[123,12,122,10],[123,13,122,11],[123,19,122,17],[124,14,123,12],[124,20,123,18,"store"],[124,25,123,23],[124,26,123,24,"push"],[124,30,123,28],[124,31,123,29,"envelope"],[124,39,123,37],[124,40,123,38],[125,12,124,10],[126,12,125,10,"flushWithBackOff"],[126,28,125,26],[126,29,125,27],[126,30,125,28],[127,12,126,10,"log"],[127,15,126,13],[127,16,126,14],[127,46,126,44],[127,48,126,46,"e"],[127,49,126,48],[127,50,126,49],[128,12,127,10],[128,19,127,17],[128,20,127,18],[128,21,127,19],[129,10,128,8],[129,11,128,9],[129,17,128,15],[130,12,129,10],[130,18,129,16,"e"],[130,19,129,17],[131,10,130,8],[132,8,131,6],[133,6,132,4],[134,6,134,4],[134,10,134,8,"options"],[134,17,134,15],[134,18,134,16,"flushAtStartup"],[134,32,134,30],[134,34,134,32],[135,8,135,6,"flushWithBackOff"],[135,24,135,22],[135,25,135,23],[135,26,135,24],[136,6,136,4],[137,6,138,4],[137,13,138,11],[138,8,139,6,"send"],[138,12,139,10],[139,8,140,6,"flush"],[139,13,140,11],[139,15,140,13,"timeout"],[139,22,140,20],[139,26,140,24],[140,10,141,8],[141,10,142,8],[141,14,142,12,"timeout"],[141,21,142,19],[141,26,142,24,"undefined"],[141,35,142,33],[141,37,142,35],[142,12,143,10,"retryDelay"],[142,22,143,20],[142,25,143,23,"START_DELAY"],[142,36,143,34],[143,12,144,10,"flushIn"],[143,19,144,17],[143,20,144,18,"MIN_DELAY"],[143,29,144,27],[143,30,144,28],[144,10,145,8],[145,10,147,8],[145,17,147,15,"transport"],[145,26,147,24],[145,27,147,25,"flush"],[145,32,147,30],[145,33,147,31,"timeout"],[145,40,147,38],[145,41,147,39],[146,8,148,6],[147,6,149,4],[147,7,149,5],[148,4,150,2],[148,5,150,3],[149,2,151,0],[150,0,151,1],[150,3]],"functionMap":{"names":["<global>","makeOfflineTransport","log","<anonymous>","shouldQueue","flushIn","setTimeout$argument_0","send._catch$argument_0","flushWithBackOff","send","flush"],"mappings":"AAA;ACc;ECG;GDE;SEE;ICY;KDW;IEE;8BCK;uCCU;WDE;ODE;KFM;IKE;KLQ;IME;KNgD;aOQ;OPQ;GFE;CDC"},"hasCjsExports":false},"type":"js/module"}]}