{"dependencies":[{"name":"../defaultScopes.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":87,"index":87}}],"key":"tAlRx+kqSuV0GNrYVk8shVRUqYA=","exportNames":["*"],"imports":1}},{"name":"../scope.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":88},"end":{"line":2,"column":36,"index":124}}],"key":"bbqqZVE6uvJ/JsOu3l9LbJk8vzU=","exportNames":["*"],"imports":1}},{"name":"../utils/is.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":125},"end":{"line":3,"column":44,"index":169}}],"key":"4+jCyIAoBTQkyvfOkvHQiJVdtho=","exportNames":["*"],"imports":1}},{"name":"../carrier.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":170},"end":{"line":4,"column":65,"index":235}}],"key":"/CHWq5A6N7GxVM0vQJS3tsMdXuE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  Object.defineProperty(exports, \"AsyncContextStack\", {\n    enumerable: true,\n    get: function () {\n      return AsyncContextStack;\n    }\n  });\n  Object.defineProperty(exports, \"getStackAsyncContextStrategy\", {\n    enumerable: true,\n    get: function () {\n      return getStackAsyncContextStrategy;\n    }\n  });\n  var _defaultScopesJs = require(_dependencyMap[0], \"../defaultScopes.js\");\n  var _scopeJs = require(_dependencyMap[1], \"../scope.js\");\n  var _utilsIsJs = require(_dependencyMap[2], \"../utils/is.js\");\n  var _carrierJs = require(_dependencyMap[3], \"../carrier.js\");\n  /**\n   * This is an object that holds a stack of scopes.\n   */\n  class AsyncContextStack {\n    constructor(scope, isolationScope) {\n      let assignedScope;\n      if (!scope) {\n        assignedScope = new _scopeJs.Scope();\n      } else {\n        assignedScope = scope;\n      }\n      let assignedIsolationScope;\n      if (!isolationScope) {\n        assignedIsolationScope = new _scopeJs.Scope();\n      } else {\n        assignedIsolationScope = isolationScope;\n      }\n\n      // scope stack for domains or the process\n      this._stack = [{\n        scope: assignedScope\n      }];\n      this._isolationScope = assignedIsolationScope;\n    }\n\n    /**\n     * Fork a scope for the stack.\n     */\n    withScope(callback) {\n      const scope = this._pushScope();\n      let maybePromiseResult;\n      try {\n        maybePromiseResult = callback(scope);\n      } catch (e) {\n        this._popScope();\n        throw e;\n      }\n      if ((0, _utilsIsJs.isThenable)(maybePromiseResult)) {\n        // @ts-expect-error - isThenable returns the wrong type\n        return maybePromiseResult.then(res => {\n          this._popScope();\n          return res;\n        }, e => {\n          this._popScope();\n          throw e;\n        });\n      }\n      this._popScope();\n      return maybePromiseResult;\n    }\n\n    /**\n     * Get the client of the stack.\n     */\n    getClient() {\n      return this.getStackTop().client;\n    }\n\n    /**\n     * Returns the scope of the top stack.\n     */\n    getScope() {\n      return this.getStackTop().scope;\n    }\n\n    /**\n     * Get the isolation scope for the stack.\n     */\n    getIsolationScope() {\n      return this._isolationScope;\n    }\n\n    /**\n     * Returns the topmost scope layer in the order domain > local > process.\n     */\n    getStackTop() {\n      return this._stack[this._stack.length - 1];\n    }\n\n    /**\n     * Push a scope to the stack.\n     */\n    _pushScope() {\n      // We want to clone the content of prev scope\n      const scope = this.getScope().clone();\n      this._stack.push({\n        client: this.getClient(),\n        scope\n      });\n      return scope;\n    }\n\n    /**\n     * Pop a scope from the stack.\n     */\n    _popScope() {\n      if (this._stack.length <= 1) return false;\n      return !!this._stack.pop();\n    }\n  }\n\n  /**\n   * Get the global async context stack.\n   * This will be removed during the v8 cycle and is only here to make migration easier.\n   */\n  function getAsyncContextStack() {\n    const registry = (0, _carrierJs.getMainCarrier)();\n    const sentry = (0, _carrierJs.getSentryCarrier)(registry);\n    return sentry.stack = sentry.stack || new AsyncContextStack((0, _defaultScopesJs.getDefaultCurrentScope)(), (0, _defaultScopesJs.getDefaultIsolationScope)());\n  }\n  function withScope(callback) {\n    return getAsyncContextStack().withScope(callback);\n  }\n  function withSetScope(scope, callback) {\n    const stack = getAsyncContextStack();\n    return stack.withScope(() => {\n      stack.getStackTop().scope = scope;\n      return callback(scope);\n    });\n  }\n  function withIsolationScope(callback) {\n    return getAsyncContextStack().withScope(() => {\n      return callback(getAsyncContextStack().getIsolationScope());\n    });\n  }\n\n  /**\n   * Get the stack-based async context strategy.\n   */\n  function getStackAsyncContextStrategy() {\n    return {\n      withIsolationScope,\n      withScope,\n      withSetScope,\n      withSetIsolationScope: (_isolationScope, callback) => {\n        return withIsolationScope(callback);\n      },\n      getCurrentScope: () => getAsyncContextStack().getScope(),\n      getIsolationScope: () => getAsyncContextStack().getIsolationScope()\n    };\n  }\n});","lineCount":164,"map":[[7,2,158,0,"Object"],[7,8,158,0],[7,9,158,0,"defineProperty"],[7,23,158,0],[7,24,158,0,"exports"],[7,31,158,0],[8,4,158,0,"enumerable"],[8,14,158,0],[9,4,158,0,"get"],[9,7,158,0],[9,18,158,0,"get"],[9,19,158,0],[10,6,158,0],[10,13,158,9,"AsyncContextStack"],[10,30,158,26],[11,4,158,26],[12,2,158,26],[13,2,158,0,"Object"],[13,8,158,0],[13,9,158,0,"defineProperty"],[13,23,158,0],[13,24,158,0,"exports"],[13,31,158,0],[14,4,158,0,"enumerable"],[14,14,158,0],[15,4,158,0,"get"],[15,7,158,0],[15,18,158,0,"get"],[15,19,158,0],[16,6,158,0],[16,13,158,28,"getStackAsyncContextStrategy"],[16,41,158,56],[17,4,158,56],[18,2,158,56],[19,2,1,0],[19,6,1,0,"_defaultScopesJs"],[19,22,1,0],[19,25,1,0,"require"],[19,32,1,0],[19,33,1,0,"_dependencyMap"],[19,47,1,0],[20,2,2,0],[20,6,2,0,"_scopeJs"],[20,14,2,0],[20,17,2,0,"require"],[20,24,2,0],[20,25,2,0,"_dependencyMap"],[20,39,2,0],[21,2,3,0],[21,6,3,0,"_utilsIsJs"],[21,16,3,0],[21,19,3,0,"require"],[21,26,3,0],[21,27,3,0,"_dependencyMap"],[21,41,3,0],[22,2,4,0],[22,6,4,0,"_carrierJs"],[22,16,4,0],[22,19,4,0,"require"],[22,26,4,0],[22,27,4,0,"_dependencyMap"],[22,41,4,0],[23,2,6,0],[24,0,7,0],[25,0,8,0],[26,2,9,0],[26,8,9,6,"AsyncContextStack"],[26,25,9,23],[26,26,9,24],[27,4,11,3,"constructor"],[27,15,11,14,"constructor"],[27,16,11,15,"scope"],[27,21,11,20],[27,23,11,22,"isolationScope"],[27,37,11,36],[27,39,11,38],[28,6,12,4],[28,10,12,8,"assignedScope"],[28,23,12,21],[29,6,13,4],[29,10,13,8],[29,11,13,9,"scope"],[29,16,13,14],[29,18,13,16],[30,8,14,6,"assignedScope"],[30,21,14,19],[30,24,14,22],[30,28,14,26,"Scope"],[30,36,14,31],[30,37,14,31,"Scope"],[30,42,14,31],[30,43,14,32],[30,44,14,33],[31,6,15,4],[31,7,15,5],[31,13,15,11],[32,8,16,6,"assignedScope"],[32,21,16,19],[32,24,16,22,"scope"],[32,29,16,27],[33,6,17,4],[34,6,19,4],[34,10,19,8,"assignedIsolationScope"],[34,32,19,30],[35,6,20,4],[35,10,20,8],[35,11,20,9,"isolationScope"],[35,25,20,23],[35,27,20,25],[36,8,21,6,"assignedIsolationScope"],[36,30,21,28],[36,33,21,31],[36,37,21,35,"Scope"],[36,45,21,40],[36,46,21,40,"Scope"],[36,51,21,40],[36,52,21,41],[36,53,21,42],[37,6,22,4],[37,7,22,5],[37,13,22,11],[38,8,23,6,"assignedIsolationScope"],[38,30,23,28],[38,33,23,31,"isolationScope"],[38,47,23,45],[39,6,24,4],[41,6,26,4],[42,6,27,4],[42,10,27,8],[42,11,27,9,"_stack"],[42,17,27,15],[42,20,27,18],[42,21,27,19],[43,8,27,21,"scope"],[43,13,27,26],[43,15,27,28,"assignedScope"],[44,6,27,42],[44,7,27,43],[44,8,27,44],[45,6,28,4],[45,10,28,8],[45,11,28,9,"_isolationScope"],[45,26,28,24],[45,29,28,27,"assignedIsolationScope"],[45,51,28,49],[46,4,29,2],[48,4,31,2],[49,0,32,0],[50,0,33,0],[51,4,34,3,"withScope"],[51,13,34,12,"withScope"],[51,14,34,13,"callback"],[51,22,34,21],[51,24,34,23],[52,6,35,4],[52,12,35,10,"scope"],[52,17,35,15],[52,20,35,18],[52,24,35,22],[52,25,35,23,"_pushScope"],[52,35,35,33],[52,36,35,34],[52,37,35,35],[53,6,37,4],[53,10,37,8,"maybePromiseResult"],[53,28,37,26],[54,6,38,4],[54,10,38,8],[55,8,39,6,"maybePromiseResult"],[55,26,39,24],[55,29,39,27,"callback"],[55,37,39,35],[55,38,39,36,"scope"],[55,43,39,41],[55,44,39,42],[56,6,40,4],[56,7,40,5],[56,8,40,6],[56,15,40,13,"e"],[56,16,40,14],[56,18,40,16],[57,8,41,6],[57,12,41,10],[57,13,41,11,"_popScope"],[57,22,41,20],[57,23,41,21],[57,24,41,22],[58,8,42,6],[58,14,42,12,"e"],[58,15,42,13],[59,6,43,4],[60,6,45,4],[60,10,45,8],[60,14,45,8,"isThenable"],[60,24,45,18],[60,25,45,18,"isThenable"],[60,35,45,18],[60,37,45,19,"maybePromiseResult"],[60,55,45,37],[60,56,45,38],[60,58,45,40],[61,8,46,6],[62,8,47,6],[62,15,47,13,"maybePromiseResult"],[62,33,47,31],[62,34,47,32,"then"],[62,38,47,36],[62,39,48,8,"res"],[62,42,48,11],[62,46,48,15],[63,10,49,10],[63,14,49,14],[63,15,49,15,"_popScope"],[63,24,49,24],[63,25,49,25],[63,26,49,26],[64,10,50,10],[64,17,50,17,"res"],[64,20,50,20],[65,8,51,8],[65,9,51,9],[65,11,52,8,"e"],[65,12,52,9],[65,16,52,13],[66,10,53,10],[66,14,53,14],[66,15,53,15,"_popScope"],[66,24,53,24],[66,25,53,25],[66,26,53,26],[67,10,54,10],[67,16,54,16,"e"],[67,17,54,17],[68,8,55,8],[68,9,56,6],[68,10,56,7],[69,6,57,4],[70,6,59,4],[70,10,59,8],[70,11,59,9,"_popScope"],[70,20,59,18],[70,21,59,19],[70,22,59,20],[71,6,60,4],[71,13,60,11,"maybePromiseResult"],[71,31,60,29],[72,4,61,2],[74,4,63,2],[75,0,64,0],[76,0,65,0],[77,4,66,3,"getClient"],[77,13,66,12,"getClient"],[77,14,66,12],[77,16,66,15],[78,6,67,4],[78,13,67,11],[78,17,67,15],[78,18,67,16,"getStackTop"],[78,29,67,27],[78,30,67,28],[78,31,67,29],[78,32,67,30,"client"],[78,38,67,36],[79,4,68,2],[81,4,70,2],[82,0,71,0],[83,0,72,0],[84,4,73,3,"getScope"],[84,12,73,11,"getScope"],[84,13,73,11],[84,15,73,14],[85,6,74,4],[85,13,74,11],[85,17,74,15],[85,18,74,16,"getStackTop"],[85,29,74,27],[85,30,74,28],[85,31,74,29],[85,32,74,30,"scope"],[85,37,74,35],[86,4,75,2],[88,4,77,2],[89,0,78,0],[90,0,79,0],[91,4,80,3,"getIsolationScope"],[91,21,80,20,"getIsolationScope"],[91,22,80,20],[91,24,80,23],[92,6,81,4],[92,13,81,11],[92,17,81,15],[92,18,81,16,"_isolationScope"],[92,33,81,31],[93,4,82,2],[95,4,84,2],[96,0,85,0],[97,0,86,0],[98,4,87,3,"getStackTop"],[98,15,87,14,"getStackTop"],[98,16,87,14],[98,18,87,17],[99,6,88,4],[99,13,88,11],[99,17,88,15],[99,18,88,16,"_stack"],[99,24,88,22],[99,25,88,23],[99,29,88,27],[99,30,88,28,"_stack"],[99,36,88,34],[99,37,88,35,"length"],[99,43,88,41],[99,46,88,44],[99,47,88,45],[99,48,88,46],[100,4,89,2],[102,4,91,2],[103,0,92,0],[104,0,93,0],[105,4,94,3,"_pushScope"],[105,14,94,13,"_pushScope"],[105,15,94,13],[105,17,94,16],[106,6,95,4],[107,6,96,4],[107,12,96,10,"scope"],[107,17,96,15],[107,20,96,18],[107,24,96,22],[107,25,96,23,"getScope"],[107,33,96,31],[107,34,96,32],[107,35,96,33],[107,36,96,34,"clone"],[107,41,96,39],[107,42,96,40],[107,43,96,41],[108,6,97,4],[108,10,97,8],[108,11,97,9,"_stack"],[108,17,97,15],[108,18,97,16,"push"],[108,22,97,20],[108,23,97,21],[109,8,98,6,"client"],[109,14,98,12],[109,16,98,14],[109,20,98,18],[109,21,98,19,"getClient"],[109,30,98,28],[109,31,98,29],[109,32,98,30],[110,8,99,6,"scope"],[111,6,100,4],[111,7,100,5],[111,8,100,6],[112,6,101,4],[112,13,101,11,"scope"],[112,18,101,16],[113,4,102,2],[115,4,104,2],[116,0,105,0],[117,0,106,0],[118,4,107,3,"_popScope"],[118,13,107,12,"_popScope"],[118,14,107,12],[118,16,107,15],[119,6,108,4],[119,10,108,8],[119,14,108,12],[119,15,108,13,"_stack"],[119,21,108,19],[119,22,108,20,"length"],[119,28,108,26],[119,32,108,30],[119,33,108,31],[119,35,108,33],[119,42,108,40],[119,47,108,45],[120,6,109,4],[120,13,109,11],[120,14,109,12],[120,15,109,13],[120,19,109,17],[120,20,109,18,"_stack"],[120,26,109,24],[120,27,109,25,"pop"],[120,30,109,28],[120,31,109,29],[120,32,109,30],[121,4,110,2],[122,2,111,0],[124,2,113,0],[125,0,114,0],[126,0,115,0],[127,0,116,0],[128,2,117,0],[128,11,117,9,"getAsyncContextStack"],[128,31,117,29,"getAsyncContextStack"],[128,32,117,29],[128,34,117,32],[129,4,118,2],[129,10,118,8,"registry"],[129,18,118,16],[129,21,118,19],[129,25,118,19,"getMainCarrier"],[129,35,118,33],[129,36,118,33,"getMainCarrier"],[129,50,118,33],[129,52,118,34],[129,53,118,35],[130,4,119,2],[130,10,119,8,"sentry"],[130,16,119,14],[130,19,119,17],[130,23,119,17,"getSentryCarrier"],[130,33,119,33],[130,34,119,33,"getSentryCarrier"],[130,50,119,33],[130,52,119,34,"registry"],[130,60,119,42],[130,61,119,43],[131,4,121,2],[131,11,121,10,"sentry"],[131,17,121,16],[131,18,121,17,"stack"],[131,23,121,22],[131,26,121,25,"sentry"],[131,32,121,31],[131,33,121,32,"stack"],[131,38,121,37],[131,42,121,41],[131,46,121,45,"AsyncContextStack"],[131,63,121,62],[131,64,121,63],[131,68,121,63,"getDefaultCurrentScope"],[131,84,121,85],[131,85,121,85,"getDefaultCurrentScope"],[131,107,121,85],[131,109,121,86],[131,110,121,87],[131,112,121,89],[131,116,121,89,"getDefaultIsolationScope"],[131,132,121,113],[131,133,121,113,"getDefaultIsolationScope"],[131,157,121,113],[131,159,121,114],[131,160,121,115],[131,161,121,116],[132,2,122,0],[133,2,124,0],[133,11,124,9,"withScope"],[133,20,124,18,"withScope"],[133,21,124,19,"callback"],[133,29,124,27],[133,31,124,29],[134,4,125,2],[134,11,125,9,"getAsyncContextStack"],[134,31,125,29],[134,32,125,30],[134,33,125,31],[134,34,125,32,"withScope"],[134,43,125,41],[134,44,125,42,"callback"],[134,52,125,50],[134,53,125,51],[135,2,126,0],[136,2,128,0],[136,11,128,9,"withSetScope"],[136,23,128,21,"withSetScope"],[136,24,128,22,"scope"],[136,29,128,27],[136,31,128,29,"callback"],[136,39,128,37],[136,41,128,39],[137,4,129,2],[137,10,129,8,"stack"],[137,15,129,13],[137,18,129,16,"getAsyncContextStack"],[137,38,129,36],[137,39,129,37],[137,40,129,38],[138,4,130,2],[138,11,130,9,"stack"],[138,16,130,14],[138,17,130,15,"withScope"],[138,26,130,24],[138,27,130,25],[138,33,130,31],[139,6,131,4,"stack"],[139,11,131,9],[139,12,131,10,"getStackTop"],[139,23,131,21],[139,24,131,22],[139,25,131,23],[139,26,131,24,"scope"],[139,31,131,29],[139,34,131,32,"scope"],[139,39,131,37],[140,6,132,4],[140,13,132,11,"callback"],[140,21,132,19],[140,22,132,20,"scope"],[140,27,132,25],[140,28,132,26],[141,4,133,2],[141,5,133,3],[141,6,133,4],[142,2,134,0],[143,2,136,0],[143,11,136,9,"withIsolationScope"],[143,29,136,27,"withIsolationScope"],[143,30,136,28,"callback"],[143,38,136,36],[143,40,136,38],[144,4,137,2],[144,11,137,9,"getAsyncContextStack"],[144,31,137,29],[144,32,137,30],[144,33,137,31],[144,34,137,32,"withScope"],[144,43,137,41],[144,44,137,42],[144,50,137,48],[145,6,138,4],[145,13,138,11,"callback"],[145,21,138,19],[145,22,138,20,"getAsyncContextStack"],[145,42,138,40],[145,43,138,41],[145,44,138,42],[145,45,138,43,"getIsolationScope"],[145,62,138,60],[145,63,138,61],[145,64,138,62],[145,65,138,63],[146,4,139,2],[146,5,139,3],[146,6,139,4],[147,2,140,0],[149,2,142,0],[150,0,143,0],[151,0,144,0],[152,2,145,0],[152,11,145,9,"getStackAsyncContextStrategy"],[152,39,145,37,"getStackAsyncContextStrategy"],[152,40,145,37],[152,42,145,40],[153,4,146,2],[153,11,146,9],[154,6,147,4,"withIsolationScope"],[154,24,147,22],[155,6,148,4,"withScope"],[155,15,148,13],[156,6,149,4,"withSetScope"],[156,18,149,16],[157,6,150,4,"withSetIsolationScope"],[157,27,150,25],[157,29,150,27,"withSetIsolationScope"],[157,30,150,28,"_isolationScope"],[157,45,150,43],[157,47,150,45,"callback"],[157,55,150,53],[157,60,150,58],[158,8,151,6],[158,15,151,13,"withIsolationScope"],[158,33,151,31],[158,34,151,32,"callback"],[158,42,151,40],[158,43,151,41],[159,6,152,4],[159,7,152,5],[160,6,153,4,"getCurrentScope"],[160,21,153,19],[160,23,153,21,"getCurrentScope"],[160,24,153,21],[160,29,153,27,"getAsyncContextStack"],[160,49,153,47],[160,50,153,48],[160,51,153,49],[160,52,153,50,"getScope"],[160,60,153,58],[160,61,153,59],[160,62,153,60],[161,6,154,4,"getIsolationScope"],[161,23,154,21],[161,25,154,23,"getIsolationScope"],[161,26,154,23],[161,31,154,29,"getAsyncContextStack"],[161,51,154,49],[161,52,154,50],[161,53,154,51],[161,54,154,52,"getIsolationScope"],[161,71,154,69],[161,72,154,70],[162,4,155,2],[162,5,155,3],[163,2,156,0],[164,0,156,1],[164,3]],"functionMap":{"names":["<global>","AsyncContextStack","AsyncContextStack#constructor","AsyncContextStack#withScope","maybePromiseResult.then$argument_0","maybePromiseResult.then$argument_1","AsyncContextStack#getClient","AsyncContextStack#getScope","AsyncContextStack#getIsolationScope","AsyncContextStack#getStackTop","AsyncContextStack#_pushScope","AsyncContextStack#_popScope","getAsyncContextStack","withScope","withSetScope","stack.withScope$argument_0","withIsolationScope","getAsyncContextStack.withScope$argument_0","getStackAsyncContextStrategy","withSetIsolationScope","getCurrentScope","getIsolationScope"],"mappings":"AAA;ACQ;GCE;GDkB;GEK;QCc;SDG;QEC;SFG;GFM;GKK;GLE;GMK;GNE;GOK;GPE;GQK;GRE;GSK;GTQ;GUK;GVG;CDC;AYM;CZK;AaE;CbE;AcE;yBCE;GDG;CdC;AgBE;0CCC;GDE;ChBC;AkBK;2BCK;KDE;qBEC,uCF;uBGC,gDH;ClBE"},"hasCjsExports":false},"type":"js/module"}]}